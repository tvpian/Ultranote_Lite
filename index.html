<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UltraNote Lite (Full, No‚ÄëSW)</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8eef7; --muted:#a9b6c6; --card:#121924; --acc:#4ea1ff; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:#0e141d;position:sticky;top:0;z-index:10;border-bottom:1px solid #1e2a3a}
    .title{font-weight:700;letter-spacing:.3px}
    .search{flex:1;max-width:520px}
    input[type="text"], textarea{width:100%;background:#0f1621;border:1px solid #203041;color:var(--fg);padding:10px;border-radius:10px;outline:none}
    textarea{min-height:140px;resize:vertical}
    main{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px}
    aside{background:var(--card);border:1px solid #1e2938;border-radius:16px;padding:12px;height:calc(100dvh - 88px);position:sticky;top:88px;overflow:auto}
    nav button{width:100%;text-align:left;background:#101827;border:1px solid #213145;color:var(--fg);padding:10px 12px;margin:6px 0;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--acc);outline:2px solid color-mix(in oklab, var(--acc) 40%, transparent)}
    .card{background:var(--card);border:1px solid #1e2938;border-radius:16px;padding:14px;margin-bottom:16px}
    .row{display:flex;gap:10px;align-items:center}
    .btn{background:#122134;border:1px solid #274768;color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.acc{border-color:var(--acc)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #334759;border-radius:999px;font-size:12px;color:var(--muted);margin-right:6px}
    .list{display:grid;gap:8px}
    .muted{color:var(--muted);font-size:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    footer{padding:16px;color:var(--muted);text-align:center}
    a{color:var(--acc)}
    .tip{position:fixed;inset:auto 16px 16px 16px;background:#0e141d;border:1px solid #243246;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .tip h4{margin:0 0 6px 0}
    .kbd{border:1px solid #3a4a60;border-radius:6px;padding:0 6px;margin:0 3px}
    .hidden{display:none}
    /* Project sidebar buttons */
    .projBtn{width:100%;text-align:left;background:#101827;border:1px solid #213145;color:var(--fg);padding:8px 10px;margin:4px 0;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .projBtn.active{border-color:var(--acc);outline:2px solid color-mix(in oklab, var(--acc) 40%, transparent)}
    .projBtn .projDel{font-size:12px;opacity:.55;padding:2px 6px;border-radius:6px;cursor:pointer;}
    .projBtn .projDel:hover{opacity:1;background:#182330;color:#ff6b6b}

    /* Responsive enhancements */
    #menuToggle{display:none;margin-right:8px;}
    .hide-mobile{display:block;}
    #mobileBar{position:fixed;bottom:0;left:0;right:0;background:#0e141d;border-top:1px solid #1e2a3a;display:none;z-index:120;padding:6px 8px;gap:6px;}
    #sketchModal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:300;padding:16px;}
    #sketchModal.show{display:flex;}
    #sketchModal .sketchInner{background:#121924;border:1px solid #1e2938;border-radius:16px;padding:12px;max-width:100%;}
    #sketchPad{background:#0f1621;border:1px solid #274768;border-radius:12px;touch-action:none;max-width:100%;height:auto;}
    #mobileBar .btn.active{border-color:var(--acc);background:#182330;}
    @media (max-width:900px){
      main{grid-template-columns:1fr;}
      aside{position:fixed;top:0;left:0;height:100dvh;transform:translateX(-100%);transition:transform .25s;background:var(--card);width:260px;z-index:200;box-shadow:0 0 30px rgba(0,0,0,.4);}
      body.drawer-open aside{transform:translateX(0);}
      body.drawer-open:after{content:'';position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);z-index:150;}
      #menuToggle{display:inline-block;}
      .hide-mobile{display:none;}
      #mobileBar{display:flex;}
      body{padding-bottom:74px;}
      header{gap:6px;}
    }
  </style>
</head>
<body>
  <header>
    <button id="menuToggle" class="btn" style="display:none;">‚ò∞</button>
    <div class="title">UltraNote Lite</div>
    <div class="search"><input id="q" type="text" placeholder="Search notes, tasks, tags‚Ä¶ (‚åò/Ctrl+K quick add)" /></div>
    <div class="row hide-mobile" id="desktopActions">
      <button id="newNoteBtn" class="btn">New Note</button>
      <label class="btn" for="importFile">Import</label>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="exportBtn" class="btn acc">Export</button>
      <label class="muted" style="margin-left:8px;"><input id="dailyRollover" type="checkbox"> Rollover incomplete tasks daily</label>
      <label class="muted" style="margin-left:8px;"><input id="autoCarryTasks" type="checkbox"> Auto-carry project tasks</label>
    </div>
  </header>

  <main>
    <aside>
      <nav id="nav"></nav>
      <div class="card">
        <div class="muted">Today: <span id="todayStr"></span></div>
        <div class="row" id="dailyDateControls" style="margin-top:8px;gap:6px;align-items:center;flex-wrap:wrap;">
          <button class="btn" id="prevDay" style="flex:0 0 auto;padding:4px 10px;font-size:14px;">‚óÄ</button>
          <input id="dailyDateNav" type="date" style="flex:1;min-width:0;background:#0f1621;border:1px solid #203041;color:var(--fg);padding:6px 8px;border-radius:8px;" />
          <button class="btn" id="nextDay" style="flex:0 0 auto;padding:4px 10px;font-size:14px;">‚ñ∂</button>
        </div>
        <button id="newDaily" class="btn" style="margin-top:8px;width:100%;">Open/Create Daily</button>
      </div>
      <div class="card">
        <div class="muted">Projects</div>
        <div id="projectList" class="list"></div>
        <div class="row" style="margin-top:8px;">
          <input id="newProjectName" type="text" placeholder="New project name"/>
          <button id="addProject" class="btn">Add</button>
        </div>
        <div style="margin-top:8px;">
          <button id="manageTemplates" class="btn" style="width:100%;font-size:12px;">Manage Templates</button>
        </div>
      </div>
    </aside>

    <section id="content"></section>
  </main>

  <div id="tip" class="tip" style="display:none;">
    <h4>üöÄ Welcome! Productivity Features</h4>
    <div class="muted">
      ‚Ä¢ <b>üìÖ Today:</b> Daily journal with task priorities (high=red, medium=blue, low=gray)<br>
      ‚Ä¢ <b>üìÅ Projects:</b> Manage project tasks & notes with templates. Pin important notes.<br>
      ‚Ä¢ <b>üí° Ideas:</b> Quick capture with <b>#tags</b>. Type <b>!</b> for high-priority tasks.<br>
      ‚Ä¢ <b>üîç Vault:</b> Search notes, filter by tags (#tag), sort & pin favorites.<br>
      ‚Ä¢ <b>üìä Review:</b> Analytics, project progress, tag cloud, weekly stats.<br>
      <br><b>Shortcuts:</b> <span class="kbd">‚åò/Ctrl</span>+<span class="kbd">K</span> = note, <span class="kbd">‚åò/Ctrl</span>+<span class="kbd">Shift</span>+<span class="kbd">K</span> = task
    </div>
    <div class="row" style="margin-top:10px;justify-content:flex-end;">
      <button id="closeTip" class="btn acc">Got it</button>
    </div>
  </div>

  <footer>Private, local-first. Data stored in your browser. <a href="#" id="resetApp">Reset</a></footer>

  <!-- Mobile bottom bar -->
  <div id="mobileBar">
    <button data-nav="today" class="btn" style="flex:1;">Today</button>
    <button data-nav="projects" class="btn" style="flex:1;">Projects</button>
    <button data-nav="ideas" class="btn" style="flex:1;">Ideas</button>
    <button data-nav="vault" class="btn" style="flex:1;">Vault</button>
    <button data-nav="review" class="btn" style="flex:1;">Review</button>
    <button id="mbNew" class="btn acc" style="flex:1;">New</button>
  </div>

  <!-- Sketch modal -->
  <div id="sketchModal" class="hidden">
    <div class="sketchInner">
      <canvas id="sketchPad" width="600" height="400"></canvas>
      <div class="row" style="flex-wrap:wrap;margin-top:8px;gap:8px;">
        <label style="font-size:12px;">Color <input type="color" id="sketchColor" value="#ffffff"></label>
        <label style="font-size:12px;">Size <input type="range" id="sketchSize" min="1" max="20" value="3"></label>
        <button class="btn" id="sketchUndo">Undo</button>
        <button class="btn" id="sketchClear">Clear</button>
        <button class="btn acc" id="sketchInsert">Insert</button>
        <button class="btn" id="sketchClose">Close</button>
      </div>
    </div>
  </div>

<script>
// --- Local-first store (now via backend) ---
const storeKey = "ultranote-lite"; // kept for compatibility
const nowISO = () => new Date().toISOString();
const todayKey = () => new Date().toISOString().slice(0,10);
// NEW: selected daily date (default today)
let selectedDailyDate = todayKey();
function createDailyNoteFor(dateKey, contentOverride){
  const exists = db.notes.find(n=>n.type==='daily' && n.dateIndex===dateKey);
  if(exists) return exists;
  const isToday = dateKey === todayKey();
  const templateContent = contentOverride !== undefined ? contentOverride : (db.settings.dailyTemplate || "# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n");
  const daily = createNote({title:`${dateKey} ‚Äî Daily`, type:'daily', dateIndex:dateKey, content:templateContent});
  if(isToday){
    if(db.settings.rollover){
      const y = new Date(); y.setDate(y.getDate()-1); const yKey = y.toISOString().slice(0,10);
      const yTasks = db.tasks.filter(t=> t.status!=='DONE' && t.status!=='BACKLOG' && t.noteId && db.notes.find(n=>n.id===t.noteId && n.dateIndex===yKey && n.type==='daily'));
      yTasks.forEach(t=> createTask({title:t.title, noteId:daily.id, priority:t.priority||'medium'}));
    }
    if(db.settings.autoCarryTasks){
      const priorities={high:3,medium:2,low:1};
      const projectPool = db.tasks.filter(t=> t.projectId && !t.noteId && t.status==='TODO')
        .sort((a,b)=>(priorities[b.priority]||2)-(priorities[a.priority]||2))
        .slice(0,5);
      projectPool.forEach(t=> createTask({title:t.title, noteId:daily.id, projectId:t.projectId, priority:t.priority}));
    }
  }
  return daily;
}
// NEW: unified handler to open or create the selected daily note (deferred creation)
function createOrOpenDaily(){
  const dateInput = document.getElementById('dailyDateNav');
  const today = todayKey();
  let key = (dateInput && dateInput.value) ? dateInput.value : (selectedDailyDate || today);
  if(key > today) key = today; // prevent future
  selectedDailyDate = key;
  // Do NOT auto-create daily note here; only render view; creation happens on user Save
  route='today';
  render();
}

// Backend persistence helpers
async function fetchDB(){
  try{
    const r = await fetch('/api/db');
    if(!r.ok) throw new Error('Fetch failed');
    const data = await r.json();
    if(!data || !Object.keys(data).length) return null;
    return data;
  }catch(e){ console.warn('Fetch DB error', e); return null; }
}
async function persistDB(){
  try{
    await fetch('/api/db', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(db)});
  }catch(e){ console.error('Persist failed', e); }
  // Always keep a browser backup too (legacy compatibility / offline resilience)
  try { localStorage.setItem(storeKey, JSON.stringify(db)); } catch(err) { /* ignore */ }
}

const seed = {
  version:1,
  settings:{rollover:true, seenTip:false, autoCarryTasks:true, dailyTemplate:"# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n"},
  projects:[{id:"p1", name:"Sample Project", createdAt:nowISO()}],
  notes:[
    {id:"n1", title:"2025-01-01 ‚Äî Daily", content:"# Top 3\n- [ ] Example task A\n- [ ] Example task B\n\n## Journal\nTried UltraNote Lite.\n", tags:[], projectId:null, dateIndex:"2025-01-01", type:"daily", createdAt:nowISO(), updatedAt:nowISO(), pinned:false},
    {id:"n2", title:"Project Plan ‚Äì Sample Project", content:"## Goals\n- Define MVP\n- Ship static site\n\n## Next\n- [ ] Sketch UI\n- [ ] Create first note\n", tags:["plan"], projectId:"p1", dateIndex:null, type:"note", createdAt:nowISO(), updatedAt:nowISO(), pinned:false},
    {id:"n3", title:"Idea: Tablet stylus block", content:"- Add sketch canvas block\n- Save as SVG\n- Optional OCR later", tags:["idea"], projectId:null, dateIndex:null, type:"idea", createdAt:nowISO(), updatedAt:nowISO(), pinned:false}
  ],
  tasks:[{id:"t1", title:"Try adding a task on Today page", status:"TODO", due:null, noteId:"n1", projectId:null, createdAt:nowISO(), completedAt:null}],
  templates:[
    {id:"tpl1", name:"Meeting Notes", content:"# Meeting: [Title]\n**Date:** [Date]\n**Attendees:** \n\n## Agenda\n- \n\n## Notes\n\n## Action Items\n- [ ] \n\n## Next Steps\n"},
    {id:"tpl2", name:"Project Plan", content:"# [Project Name]\n\n## Objective\n\n## Goals\n- \n\n## Milestones\n- [ ] \n\n## Resources\n\n## Risks\n\n## Success Metrics\n"},
    {id:"tpl3", name:"Weekly Review", content:"# Week of [Date]\n\n## Wins\n- \n\n## Challenges\n- \n\n## Lessons Learned\n- \n\n## Next Week Focus\n- [ ] \n"}
  ],
  // NEW collection for saved links
  links:[
    {id:"l1", title:"UltraNote Example", url:"https://example.com", tags:["ref"], pinned:true, status:"NEW", createdAt:nowISO(), updatedAt:nowISO()}
  ]
};
const defaults = seed;

// --- Restored runtime glue (was missing) ---
let db; // global in‚Äëmemory state
function uid(){ return Math.random().toString(36).slice(2,10); }
// Backwards compatibility: some calls still pass db => ignore param
function save(){ persistDB(); }
// Debounced override to reduce write frequency
let _saveTimer; function save(){ clearTimeout(_saveTimer); _saveTimer = setTimeout(()=>persistDB(), 400); }

async function initApp(){
  // 1. Try server
  let serverData = await fetchDB();
  if(serverData && Object.keys(serverData).length){
    db = serverData;
  } else {
    // 2. Fallback to any localStorage copy
    try { db = JSON.parse(localStorage.getItem(storeKey)||'null'); } catch(_) { db = null; }
    if(!db) db = JSON.parse(JSON.stringify(defaults));
    await persistDB();
  }
  // Defensive: ensure collections exist (added links)
  ['notes','tasks','projects','templates','settings','links'].forEach(k=>{ if(!db[k]) db[k] = Array.isArray(seed[k])?[]:{}; });
  // Draw initial UI
  drawProjectsSidebar();
  render();
}
// --- End restored runtime glue ---

// Patch model functions to call save() without args
function createNote({title, content="", tags=[], projectId=null, dateIndex=null, type="note", pinned=false}){
  const n = { id:uid(), title, content, tags, projectId, dateIndex, type, pinned, createdAt:nowISO(), updatedAt:nowISO() };
  db.notes.push(n); save(); return n;
}
function updateNote(id, patch){ const n=db.notes.find(x=>x.id===id); if(!n) return; Object.assign(n, patch, {updatedAt:nowISO()}); save(); return n; }
function createTask({title, due=null, noteId=null, projectId=null, priority="medium"}){
  const t = { id:uid(), title, status:"TODO", due, noteId, projectId, priority, createdAt:nowISO(), completedAt:null };
  db.tasks.push(t); save(); return t;
}
function setTaskStatus(id, status){ const t=db.tasks.find(x=>x.id===id); if(!t) return; t.status=status; t.completedAt = status==="DONE"? nowISO(): null; save(); }
// New helper to move a task to backlog
function moveToBacklog(id){ const t=db.tasks.find(x=>x.id===id); if(!t) return; t.status='BACKLOG'; save(); }
function createProject(name){ const p={id:uid(), name, createdAt:nowISO()}; db.projects.push(p); save(); return p; }
function createTemplate(name, content){ const t={id:uid(), name, content, createdAt:nowISO()}; db.templates.push(t); save(); return t; }
function addTag(text){ const tags = extractTags(text); if(tags.length) { const uniqueTags = [...new Set([...getAllTags(), ...tags])]; } return tags; }
function getAllTags(){ return [...new Set(db.notes.flatMap(n=>n.tags||[]).filter(Boolean))]; }
function extractTags(text){ return (text.match(/#[\w-]+/g) || []).map(tag => tag.slice(1)); }
// --- Links helpers ---
function createLink({title,url,tags=[],pinned=false,status="NEW"}){ const l={id:uid(), title, url, tags, pinned, status, createdAt:nowISO(), updatedAt:nowISO()}; db.links.push(l); save(); return l; }
function updateLink(id, patch){ const l=db.links.find(x=>x.id===id); if(!l) return; Object.assign(l, patch, {updatedAt:nowISO()}); save(); return l; }
function deleteLink(id){ db.links = db.links.filter(l=> l.id!==id); save(); }

// --- UI helpers ---
const $ = sel => document.querySelector(sel);
const content = $("#content");
const nav = $("#nav");
const projectList = $("#projectList");

const sections = [
  {id:"today", label:"üìÖ Today"},
  {id:"projects", label:"üìÅ Projects"},
  {id:"ideas", label:"üí° Ideas"},
  {id:"links", label:"üîó Links"}, // NEW
  {id:"vault", label:"üîç Vault"},
  {id:"review", label:"üìä Review"},
];
let route = "today";
let currentProjectId = null; // NEW: selected project

function renderNav(){
  nav.innerHTML = sections.map(s => `<button data-route="${s.id}" class="${route===s.id?'active':''}">${s.label}</button>`).join("");
  nav.querySelectorAll("button").forEach(b=> b.onclick = ()=>{ route=b.dataset.route; if(route==='today') selectedDailyDate = todayKey(); render(); });
}

function htmlesc(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

// Restored: drawProjectsSidebar (was missing causing project UI break)
function drawProjectsSidebar(){
  if(!projectList) return;
  projectList.innerHTML = db.projects.map(p=> `
    <button class="projBtn ${currentProjectId===p.id?"active":""}" data-proj="${p.id}" title="Select project">
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${htmlesc(p.name)}</span>
      <span class="projDel" data-del="${p.id}" title="Delete project">‚úï</span>
    </button>`).join("");
  if(!projectList.dataset.bound){
    projectList.addEventListener('click', (e)=>{
      const del = e.target.closest('.projDel');
      if(del){
        e.stopPropagation();
        const pid = del.dataset.del;
        const proj = db.projects.find(p=>p.id===pid);
        if(!proj) return;
        const noteCount = db.notes.filter(n=>n.projectId===pid).length;
        const taskCount = db.tasks.filter(t=>t.projectId===pid).length;
        const msg = `Delete project "${proj.name}"${noteCount||taskCount?` (and its ${noteCount} notes / ${taskCount} tasks)`:''}? This cannot be undone.`;
        if(!confirm(msg)) return;
        db.notes = db.notes.filter(n=> n.projectId!==pid);
        db.tasks = db.tasks.filter(t=> t.projectId!==pid);
        db.projects = db.projects.filter(p=> p.id!==pid);
        if(currentProjectId===pid) currentProjectId = null;
        save();
        drawProjectsSidebar();
        if(route==='projects') render();
        return;
      }
      const btn = e.target.closest('.projBtn');
      if(btn){
        const pid = btn.dataset.proj;
        if(currentProjectId!==pid){ currentProjectId = pid; route='projects'; render(); drawProjectsSidebar(); }
      }
    });
    projectList.dataset.bound='1';
  }
}

function htmlesc(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

// --- Draft note helper ---
function openDraftNote({title='', projectId=null, type='note', templateId=''}){
  // Prepare initial content from template if provided
  let contentTxt='';
  if(templateId){
    const tpl = db.templates.find(t=>t.id===templateId);
    if(tpl){
      contentTxt = tpl.content
        .replace(/\[Title\]/g, title)
        .replace(/\[Date\]/g, new Date().toLocaleDateString())
        .replace(/\[Project Name\]/g, projectId? (db.projects.find(p=>p.id===projectId)?.name || '') : '');
    }
  }
  content.innerHTML = `
    <div class="card">
      <div class="muted" style="margin-bottom:6px;">Draft (not saved yet)</div>
      <input id="draftTitle" type="text" value="${htmlesc(title)}" placeholder="Title" />
      <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px;">
        <input id="draftTags" type="text" placeholder="Tags (space separated)" />
        <label style="margin-left:8px;"><input id="draftPinned" type="checkbox"> Pin</label>
        <button id="draftAddSketch" class="btn" style="font-size:12px;">Add Sketch</button>
      </div>
      <div style="margin-top:8px;"><textarea id="draftContent" style="min-height:300px;">${htmlesc(contentTxt)}</textarea></div>
      <div class="row" style="margin-top:8px; gap:8px;flex-wrap:wrap;">
        <button id="draftSave" class="btn acc">Save</button>
        <button id="draftCancel" class="btn">Cancel</button>
      </div>
    </div>`;
  document.getElementById('draftSave').onclick = ()=>{
    const t = document.getElementById('draftTitle').value.trim() || 'Untitled';
    const tags = (document.getElementById('draftTags').value||'').split(/\s+/).map(x=>x.startsWith('#')?x.slice(1):x).filter(Boolean);
    const n = createNote({title:t, content:document.getElementById('draftContent').value, tags, projectId, type, pinned: document.getElementById('draftPinned').checked});
    openNote(n.id);
  };
  document.getElementById('draftCancel').onclick = ()=>{ if(projectId){ route='projects'; render(); } else { route='vault'; render(); } };
  const addSketchBtn = document.getElementById('draftAddSketch');
  if(typeof openSketchModal==='function') addSketchBtn.onclick = ()=>{
    // Insert sketch at caret later; for draft we reuse existing sketch logic by temporarily creating an off-screen note? Simplest: open modal and after insert we append to textarea.
    const originalInsert = window.openSketchModal;
    // Use existing openSketchModal but pass a temporary note id not used; after export we just append.
    openSketchModal('__draft__');
    // Monkey patch insertion handler after modal opens handled in existing code (not perfect, kept simple)
  };
}

// --- Views ---
function renderToday(){
  const key = selectedDailyDate || todayKey();
  const daily = db.notes.find(n=>n.type==='daily' && n.dateIndex===key) || null;
  const projectTasks = db.tasks.filter(t=> t.projectId && !t.noteId && t.status!=='BACKLOG').sort((a,b)=> { const priorities={high:3,medium:2,low:1}; return (priorities[b.priority]||2)-(priorities[a.priority]||2); });
  if(!daily){
    const tpl = db.settings.dailyTemplate || "# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n";
    content.innerHTML = `
      <div class='card'>
        <strong>Create Daily for ${key}</strong>
        <div class='muted' style='margin-top:4px;font-size:12px;'>Not yet in vault. Editing below won't save until you click Create.</div>
        <div style='margin-top:8px;'><textarea id='dailyNewContent' style='min-height:300px;'>${htmlesc(tpl)}</textarea></div>
        <div class='row' style='margin-top:8px;gap:8px;flex-wrap:wrap;'>
          <button id='createDailyBtn' class='btn acc'>Create & Save</button>
        </div>
        <div class='muted' style='margin-top:6px;font-size:11px;'>Rollover / auto-carry will occur only after creation (today only).</div>
      </div>`;
    document.getElementById('createDailyBtn').onclick = ()=>{
      const contentVal = document.getElementById('dailyNewContent').value;
      createDailyNoteFor(key, contentVal);
      renderToday();
    };
    return;
  }
  content.innerHTML = `
    <div class="card">
      <div class="row" style="gap:8px;flex-wrap:wrap;">
        <input id="dailyTitle" type="text" value="${htmlesc(daily.title)}"/>
      </div>
      <div style="margin-top:8px;"><textarea id="dailyContent">${htmlesc(daily.content)}</textarea></div>
      <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px;">
        <button id="saveDaily" class="btn acc">Save</button>
        <select id="templateSelect" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
          <option value="">Apply Template...</option>
          ${db.templates.map(t=>`<option value="${t.id}">${htmlesc(t.name)}</option>`).join("")}
        </select>
        <button id="toggleBacklog" class="btn" style="font-size:12px;">Backlog ‚ñæ</button>
      </div>
      <div class="muted" style="margin-top:6px;font-size:11px;">${key===todayKey()? 'Current day' : 'Viewing: '+ new Date(key+"T00:00:00").toDateString()}</div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px;">
          <strong>${key===todayKey()?"Today's Tasks":"Tasks"}</strong>
          <div class="row" style="gap:6px;">
            <button id="showProjectTasks" class="btn" style="font-size:12px;">${projectTasks.length} project tasks</button>
          </div>
        </div>
        <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap;">
          <input id="taskTitle" type="text" placeholder="Quick task (Enter to add)" ${key!==todayKey()? 'disabled title="Add tasks only on current day"':''}/>
          <select id="taskPriority" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;" ${key!==todayKey()? 'disabled':''}>
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div id="taskList" class="list" style="margin-top:8px;"></div>
        <div id="backlogList" class="list" style="margin-top:8px;display:none;border-top:1px solid #1e2938;padding-top:8px;"></div>
        <div id="projectTaskList" class="list" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="card">
        <div class="muted">Quick Capture (today only)</div>
        <div class="row" style="margin-top:8px;">
          <input id="quickCapture" type="text" placeholder="‚åò/Ctrl+Shift+K for quick add" ${key!==todayKey()? 'disabled':''}/>
          <button id="captureBtn" class="btn" ${key!==todayKey()? 'disabled':''}>Add</button>
        </div>
        <div class="muted" style="margin-top:12px;">Scratchpad</div>
        <textarea id="scratch" placeholder="Temporary notes..."></textarea>
      </div>
    </div>`;
  $("#saveDaily").onclick = ()=> { updateNote(daily.id, { title: $("#dailyTitle").value, content: $("#dailyContent").value }); };
  $("#templateSelect").onchange = (e)=> { if(!e.target.value) return; const template = db.templates.find(t=>t.id===e.target.value); if(template && confirm(`Apply "${template.name}" template? This will replace current content.`)){ $("#dailyContent").value = template.content.replace(/\[Date\]/g, new Date().toLocaleDateString()).replace(/\[Title\]/g, ''); } e.target.value=''; };
  const taskInput = $("#taskTitle"); const quickCapture = $("#quickCapture");
  taskInput?.addEventListener('keydown', e=>{ if(e.key==='Enter' && taskInput.value.trim()){ createTask({title:taskInput.value.trim(), noteId: daily.id, priority: $("#taskPriority").value}); taskInput.value=''; drawTasks(); }});
  const handleQuickCapture = ()=>{ if(!quickCapture) return; const text = quickCapture.value.trim(); if(!text) return; if(text.startsWith('!')){ createTask({title:text.slice(1), noteId:daily.id, priority:'high'}); } else if(text.includes('#')) { const tags = extractTags(text); createNote({title:text, type:'idea', tags}); } else { createTask({title:text, noteId:daily.id, priority:'medium'}); } quickCapture.value=''; drawTasks(); };
  quickCapture?.addEventListener('keydown', e=>{ if(e.key==='Enter') handleQuickCapture(); });
  $("#captureBtn")?.addEventListener('click', handleQuickCapture);
  $("#showProjectTasks").onclick = ()=>{ const list = $("#projectTaskList"); const isVisible = list.style.display !== 'none'; list.style.display = isVisible? 'none':'block'; drawProjectTasks(); };
  $("#toggleBacklog").onclick = ()=>{ const bl = $("#backlogList"); bl.style.display = bl.style.display==='none'? 'block':'none'; drawBacklog(); };
  function drawTasks(){
    const list = $("#taskList"); if(!list) return;
    const tasks = db.tasks.filter(t=> t.noteId===daily.id && t.status!=='BACKLOG')
      .sort((a,b)=> { if(a.status!==b.status) return a.status==='DONE'?1:-1; const p={high:3,medium:2,low:1}; return (p[b.priority]||2)-(p[a.priority]||2); });
    list.innerHTML = tasks.map(t=> { const colors={high:'#ff6b6b',medium:'#4ea1ff',low:'#64748b'}; return `<div class='row' style='justify-content:space-between;'>
      <label class='row' style='gap:8px;'>
        <input type='checkbox' ${t.status==='DONE'? 'checked':''} data-id='${t.id}'/>
        <span class='${t.status==='DONE'?'muted':''}' style='border-left:3px solid ${colors[t.priority||'medium']};padding-left:8px;'>${htmlesc(t.title)}</span>
      </label>
      <div class='row' style='gap:6px;'>
        ${t.status!=='DONE'?`<button class='btn' data-b='${t.id}' style='font-size:11px;'>Backlog</button>`:''}
        <button class='btn' data-del='${t.id}' title='Delete'>‚úï</button>
      </div>
    </div>`; }).join('');
    list.querySelectorAll("input[type=checkbox]").forEach(cb=> cb.onchange = ()=>{ setTaskStatus(cb.dataset.id, cb.checked? 'DONE':'TODO'); drawTasks(); drawBacklog(); });
    list.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(); drawTasks(); drawProjectTasks(); drawBacklog(); });
    list.querySelectorAll('[data-b]').forEach(b=> b.onclick = ()=>{ moveToBacklog(b.dataset.b); drawTasks(); drawBacklog(); });
  }
  function drawBacklog(){ const list = $("#backlogList"); if(!list || list.style.display==='none') return; const tasks = db.tasks.filter(t=> t.noteId===daily.id && t.status==='BACKLOG'); list.innerHTML = tasks.length? tasks.map(t=> `<div class='row' style='justify-content:space-between;'>
      <span class='muted' style='font-size:12px;'>${htmlesc(t.title)}</span>
      <div class='row' style='gap:6px;'>
        <button class='btn' data-r='${t.id}' style='font-size:11px;'>Restore</button>
        <button class='btn' data-del='${t.id}' style='font-size:11px;'>‚úï</button>
      </div>
    </div>`).join('') : `<div class='muted' style='font-size:12px;'>No backlog tasks</div>`; list.querySelectorAll('[data-r]').forEach(b=> b.onclick = ()=>{ setTaskStatus(b.dataset.r,'TODO'); drawTasks(); drawBacklog(); }); list.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(); drawBacklog(); }); }
  function drawProjectTasks(){ const list = $("#projectTaskList"); if(!list) return; const tasks = projectTasks.slice(0,10); list.innerHTML = tasks.map(t=> { const proj=db.projects.find(p=>p.id===t.projectId); const colors={high:'#ff6b6b',medium:'#4ea1ff',low:'#64748b'}; return `<div class='row' style='justify-content:space-between;'>
      <label class='row' style='gap:8px;'>
        <input type='checkbox' ${t.status==='DONE'? 'checked':''} data-id='${t.id}'/>
        <span class='${t.status==='DONE'?'muted':''}' style='border-left:3px solid ${colors[t.priority||'medium']};padding-left:8px;'>${htmlesc(t.title)} <span class='pill'>${proj?htmlesc(proj.name):'Unknown'}</span></span>
      </label>
      <div class='row' style='gap:6px;'>
        ${t.status!=='DONE'?`<button class='btn' data-b='${t.id}' style='font-size:11px;'>Backlog</button>`:''}
        <button class='btn' data-del='${t.id}'>‚úï</button>
      </div>
    </div>`; }).join(''); list.querySelectorAll("input[type=checkbox]").forEach(cb=> cb.onchange = ()=>{ setTaskStatus(cb.dataset.id, cb.checked? 'DONE':'TODO'); drawProjectTasks(); }); list.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(); drawProjectTasks(); }); list.querySelectorAll('[data-b]').forEach(b=> b.onclick = ()=>{ moveToBacklog(b.dataset.b); drawProjectTasks(); });
  }
  drawTasks(); drawBacklog();
}
function renderProjects(){
  const selectedProject = db.projects.find(p=>p.id===currentProjectId) || null;
  if(!selectedProject){
    content.innerHTML = `
      <div class="card">
        <strong>Select a project</strong>
        <div class="muted" style="margin-top:6px;">Pick a project in the left sidebar (or create one) to add and manage its notes.</div>
      </div>`;
    return;
  }
  let sortBy = 'date';
  content.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <strong>Project: ${htmlesc(selectedProject.name)}</strong>
        <div class="row" style="gap:12px;">
          <span class="muted" id="projNoteCount"></span>
          <span class="muted" id="projTaskProgress"></span>
        </div>
      </div>
      <div class="row" style="margin-top:10px;flex-wrap:wrap;gap:8px;">
        <input id="noteTitle" type="text" placeholder="New note title for this project" />
        <select id="noteTemplate" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
          <option value="">Template...</option>
          ${db.templates.map(t=>`<option value="${t.id}">${htmlesc(t.name)}</option>`).join("")}
        </select>
        <button id="addNote" class="btn acc">Add Note</button>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px;">
          <strong>Project Tasks</strong>
          <span class="muted" id="projProgressInline"></span>
        </div>
        <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap;">
          <input id="taskTitle" type="text" placeholder="New project task"/>
          <select id="taskPriority" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
          <button id="addTask" class="btn">Add Task</button>
        </div>
        <div id="taskList" class="list" style="margin-top:8px;"></div>
        <div id="projBacklogList" class="list" style="margin-top:8px;border-top:1px solid #1e2938;padding-top:8px;"></div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Notes</strong>
          <div class="row">
            <button id="sortTitle" class="btn" style="font-size:12px;">A-Z</button>
            <button id="sortDate" class="btn" style="font-size:12px;">Date</button>
          </div>
        </div>
        <div id="notes" class="list" style="margin-top:8px;"></div>
      </div>
    </div>`;
  function getProjectTasks(){ return db.tasks.filter(t=>t.projectId===currentProjectId && t.status!=='BACKLOG'); }
  function getProjectBacklog(){ return db.tasks.filter(t=>t.projectId===currentProjectId && t.status==='BACKLOG'); }
  function getProjectNotes(){ return db.notes.filter(n=> n.projectId===currentProjectId && (!n.type || n.type==='note')); }
  function drawNotes(){
    const notes = getProjectNotes().sort((a,b)=> sortBy==="title"? a.title.localeCompare(b.title) : b.updatedAt.localeCompare(a.updatedAt));
    const listEl = document.getElementById("notes");
    if(!notes.length){ listEl.innerHTML = `<div class='card muted'>No notes yet. Add one above.</div>`; return; }
    listEl.innerHTML = notes.map(n=> `<div class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>${htmlesc(n.title)}</strong>
        <div class="row" style="gap:8px;">
          ${n.pinned?'<span title="Pinned">üìå</span>':''}
          <div class="muted">${new Date(n.updatedAt).toLocaleDateString()}</div>
        </div>
      </div>
      ${(n.tags&&n.tags.length)?`<div style='margin-top:4px;'>${n.tags.map(tag=>`<span class='pill'>#${htmlesc(tag)}</span>`).join("")}</div>`:''}
      <div class="row" style="margin-top:8px; gap:8px;">
        <button class="btn" data-open="${n.id}">Open</button>
        <button class="btn" data-pin="${n.id}">${n.pinned?'Unpin':'Pin'}</button>
        <button class="btn" data-del="${n.id}">Delete</button>
      </div>
    </div>`).join("");
    listEl.querySelectorAll('[data-open]').forEach(b=> b.onclick = ()=> openNote(b.dataset.open));
    listEl.querySelectorAll('[data-pin]').forEach(b=> b.onclick = ()=> { const note=db.notes.find(x=>x.id===b.dataset.pin); if(note){ note.pinned=!note.pinned; save(); drawNotes(); } });
    listEl.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> { if(confirm('Delete this note?')){ db.notes = db.notes.filter(x=>x.id!==b.dataset.del); save(); drawNotes(); refreshStats(); } });
  }
  function refreshStats(){
    const tasks = getProjectTasks();
    const notes = getProjectNotes();
    const completed = tasks.filter(t=>t.status==="DONE").length;
    const progress = tasks.length ? Math.round(completed/tasks.length*100) : 0;
    const noteCountEl = document.getElementById("projNoteCount"); if(noteCountEl) noteCountEl.textContent = `${notes.length} notes`;
    const progEl = document.getElementById("projTaskProgress"); if(progEl) progEl.textContent = `${completed}/${tasks.length} tasks (${progress}%)`;
    const inline = document.getElementById("projProgressInline"); if(inline) inline.textContent = `${progress}% complete`;
  }
  document.getElementById("addNote").onclick = ()=>{
    const t = document.getElementById("noteTitle").value.trim();
    const templateId = document.getElementById("noteTemplate").value;
    openDraftNote({title:t, projectId:currentProjectId, type:'note', templateId});
  };
  document.getElementById("addTask").onclick = ()=>{ const title = document.getElementById("taskTitle").value.trim(); if(!title) return; createTask({title, projectId:currentProjectId, priority:document.getElementById("taskPriority").value}); document.getElementById("taskTitle").value=""; drawTasks(); refreshStats(); };
  document.getElementById("taskTitle").onkeydown = e=>{ if(e.key==="Enter") document.getElementById("addTask").click(); };
  document.getElementById("sortTitle").onclick = ()=>{ sortBy="title"; drawNotes(); };
  document.getElementById("sortDate").onclick = ()=>{ sortBy="date"; drawNotes(); };
  function drawTasks(){ const tasks = getProjectTasks().sort((a,b)=>{ if(a.status !== b.status) return a.status==="DONE"?1:-1; const priorities={high:3,medium:2,low:1}; return (priorities[b.priority]||2)-(priorities[a.priority]||2); }); const list = document.getElementById("taskList"); list.innerHTML = tasks.map(t=>{ const colors={high:"#ff6b6b",medium:"#4ea1ff",low:"#64748b"}; return `<div class="row" style="justify-content:space-between;">
        <label class="row" style="gap:8px;">
          <input type="checkbox" ${t.status==="DONE"?"checked":''} data-id="${t.id}"/>
          <span class="${t.status==='DONE'?'muted':''}" style="border-left:3px solid ${colors[t.priority||'medium']};padding-left:8px;">${htmlesc(t.title)}</span>
        </label>
        <div class='row' style='gap:6px;'>
          ${t.status!=='DONE'?`<button class='btn' data-b='${t.id}' style='font-size:11px;'>Backlog</button>`:''}
          <button class='btn' data-del='${t.id}'>‚úï</button>
        </div>
      </div>`; }).join(""); list.querySelectorAll("input[type=checkbox]").forEach(cb=> cb.onchange = ()=>{ setTaskStatus(cb.dataset.id, cb.checked?"DONE":"TODO"); drawTasks(); refreshStats(); drawBacklog(); }); list.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(db); drawTasks(); refreshStats(); drawBacklog(); }); list.querySelectorAll('[data-b]').forEach(b=> b.onclick = ()=>{ moveToBacklog(b.dataset.b); drawTasks(); drawBacklog(); refreshStats(); }); }
  function drawBacklog(){ const list = document.getElementById('projBacklogList'); const tasks = getProjectBacklog(); list.innerHTML = `<div class='muted' style='font-size:12px;margin-bottom:4px;'>Backlog (${tasks.length})</div>` + (tasks.length? tasks.map(t=> `<div class='row' style='justify-content:space-between;'>
      <span class='muted' style='font-size:12px;'>${htmlesc(t.title)}</span>
      <div class='row' style='gap:6px;'>
        <button class='btn' data-r='${t.id}' style='font-size:11px;'>Restore</button>
        <button class='btn' data-del='${t.id}' style='font-size:11px;'>‚úï</button>
      </div>
    </div>`).join("") : `<div class='muted' style='font-size:12px;'>No backlog tasks</div>`); list.querySelectorAll('[data-r]').forEach(b=> b.onclick = ()=> { setTaskStatus(b.dataset.r,'TODO'); drawTasks(); drawBacklog(); }); list.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> { db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(db); drawBacklog(); refreshStats(); });
  }
  drawTasks();
  drawNotes();
  drawBacklog();
  refreshStats();
}
function renderIdeas(){
  content.innerHTML = `
  <div class="card">
    <div class="row"><input id="idea" type="text" placeholder="Capture an idea‚Ä¶ (Enter to add)" style="flex:1;"/></div>
  </div>
  <div id="ideaList" class="list"></div>`;
  const idea = $("#idea");
  idea.onkeydown = (e)=> { if(e.key==="Enter" && idea.value.trim()){ const n=createNote({title:idea.value.trim(), content:"", type:"idea"}); idea.value=""; draw(); openNote(n.id); } };
  function draw(){
    const notes = db.notes.filter(n=> n.type==="idea").sort((a,b)=> b.createdAt.localeCompare(a.createdAt));
    $("#ideaList").innerHTML = notes.map(n=> `
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <span style="flex:1;cursor:pointer;" data-open="${n.id}">${htmlesc(n.title)}</span>
          <div class="row" style="gap:6px;">
            <button class="btn" data-open="${n.id}" style="font-size:12px;">Open</button>
            <button class="btn" data-del="${n.id}" style="font-size:12px;">‚úï</button>
          </div>
        </div>
      </div>`).join("");
    document.querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openNote(b.dataset.open));
    document.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ if(confirm('Delete idea?')){ db.notes=db.notes.filter(x=>x.id!==b.dataset.del); save(); draw(); } });
  }
  draw();
}

function renderReview(){
  const done = db.tasks.filter(t=> t.status==='DONE');
  const activeTasks = db.tasks.filter(t=> t.status!=='BACKLOG');
  const total = activeTasks.length; // fix 0/1 bug
  const pct = total? Math.round(done.length/total*100) : 0;
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
  const weekTasks = db.tasks.filter(t=> t.completedAt && new Date(t.completedAt) > weekAgo);
  const weekNotes = db.notes.filter(n=> new Date(n.createdAt) > weekAgo);
  const projectStats = db.projects.map(p=>{ const tasks = db.tasks.filter(t=>t.projectId===p.id); const completed = tasks.filter(t=>t.status==="DONE").length; return {project: p, total: tasks.length, completed, progress: tasks.length ? Math.round(completed/tasks.length*100) : 0}; }).filter(s=>s.total>0);
  const pendingAll = db.tasks.filter(t=> t.status==='TODO' && t.status!=='BACKLOG');
  const backlogAll = db.tasks.filter(t=> t.status==='BACKLOG');
  const pPriority = {high:3,medium:2,low:1};
  pendingAll.sort((a,b)=> (pPriority[b.priority]||2)-(pPriority[a.priority]||2));
  backlogAll.sort((a,b)=> (pPriority[b.priority]||2)-(pPriority[a.priority]||2));
  content.innerHTML = `
    <div class="grid-2">
      <div class="card">
        <strong>üìä Analytics</strong>
        <div class="muted" style="margin-top:6px;">Tasks completed: ${done.length}/${total||0} (${pct}%)</div>
        <div class="muted">This week: ${weekTasks.length} tasks, ${weekNotes.length} notes</div>
      </div>
      <div class="card">
        <strong>üéØ Project Progress</strong>
        <div class="list" style="margin-top:8px;">
          ${projectStats.map(s=>`<div class='row' style='justify-content:space-between;'><span>${htmlesc(s.project.name)}</span><span class='muted'>${s.completed}/${s.total} (${s.progress}%)</span></div>`).join('') || '<div class="muted">No project tasks yet</div>'}
        </div>
      </div>
    </div>
    <div class="card">
      <strong>üïí Pending Tasks (${pendingAll.length})</strong>
      <div class="list" style="margin-top:8px;max-height:240px;overflow:auto;">
        ${pendingAll.map(t=>{ const proj = t.projectId ? db.projects.find(p=>p.id===t.projectId) : null; const note = t.noteId ? db.notes.find(n=>n.id===t.noteId) : null; const label = htmlesc(t.title); const ctx = proj? `<span class='pill'>${htmlesc(proj.name)}</span>` : (note && note.type==='daily'? `<span class='pill'>${note.dateIndex}</span>` : ''); const colors={high:'#ff6b6b',medium:'#4ea1ff',low:'#64748b'}; return `<div class='row' style='justify-content:space-between;align-items:center;'>
          <span style='border-left:3px solid ${colors[t.priority||'medium']};padding-left:6px;'>${label} ${ctx}</span>
          <div class='row' style='gap:4px;'>
            ${note? `<button class='btn' data-open-note='${note.id}' style='font-size:11px;'>Open</button>`:''}
            <button class='btn' data-done='${t.id}' style='font-size:11px;'>‚úì</button>
          </div>
        </div>`; }).join('') || '<div class="muted">No pending tasks</div>'}
      </div>
    </div>
    <div class="card">
      <strong>üì¶ Backlog Tasks (${backlogAll.length})</strong>
      <div class="list" style="margin-top:8px;max-height:240px;overflow:auto;">
        ${backlogAll.map(t=>{ const proj = t.projectId ? db.projects.find(p=>p.id===t.projectId) : null; const note = t.noteId ? db.notes.find(n=>n.id===t.noteId) : null; const label = htmlesc(t.title); const ctx = proj? `<span class='pill'>${htmlesc(proj.name)}</span>` : (note && note.type==='daily'? `<span class='pill'>${note.dateIndex}</span>` : ''); return `<div class='row' style='justify-content:space-between;align-items:center;'>
          <span class='muted' style='padding-left:6px;'>${label} ${ctx}</span>
          <div class='row' style='gap:4px;'>
            ${note? `<button class='btn' data-open-note='${note.id}' style='font-size:11px;'>Open</button>`:''}
            <button class='btn' data-restore='${t.id}' style='font-size:11px;'>Restore</button>
          </div>
        </div>`; }).join('') || '<div class="muted">No backlog tasks</div>'}
      </div>
    </div>
    <div class="card">
      <strong>üìÖ Recent Daily Logs</strong>
      <div class="list" style="margin-top:8px;">${db.notes.filter(n=>n.type==='daily').slice(-7).reverse().map(n=> `<div class='row' style='justify-content:space-between;'><span>${htmlesc(n.title)}</span><button class='btn' data-open='${n.id}'>Open</button></div>`).join('')}</div>
    </div>
    <div class="card">
      <strong>üè∑Ô∏è Tag Cloud</strong>
      <div style="margin-top:8px;">${getAllTags().slice(0,20).map(tag=>{ const count = db.notes.filter(n=>(n.tags||[]).includes(tag)).length; return `<button class='pill' data-tag='${tag}' style='cursor:pointer;margin:2px;'>#${htmlesc(tag)} (${count})</button>`; }).join('') || '<div class="muted">No tags yet</div>'}</div>
    </div>`;
  content.querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openNote(b.dataset.open));
  content.querySelectorAll('[data-open-note]').forEach(b=> b.onclick=()=> openNote(b.dataset.openNote));
  content.querySelectorAll('[data-done]').forEach(b=> b.onclick=()=>{ setTaskStatus(b.dataset.done,'DONE'); renderReview(); });
  content.querySelectorAll('[data-restore]').forEach(b=> b.onclick=()=>{ setTaskStatus(b.dataset.restore,'TODO'); renderReview(); });
  content.querySelectorAll('[data-tag]').forEach(b=> b.onclick=()=>{ route='vault'; document.getElementById('q').value='#'+b.dataset.tag; render(); });
}

// --- Added: Vault & Links views (previously missing) ---
function renderVault(){
  const query = (document.getElementById('q')?.value || '').trim();
  const tagFilters = (query.match(/#[\w-]+/g)||[]).map(t=>t.slice(1).toLowerCase());
  const text = query.replace(/#[\w-]+/g,'').trim().toLowerCase();
  let notes = db.notes.slice();
  if(tagFilters.length){ notes = notes.filter(n=> tagFilters.every(t=> (n.tags||[]).map(x=>x.toLowerCase()).includes(t))); }
  if(text){ notes = notes.filter(n=> n.title.toLowerCase().includes(text) || (n.content||'').toLowerCase().includes(text)); }
  notes.sort((a,b)=> (b.pinned?1:0)-(a.pinned?1:0) || b.updatedAt.localeCompare(a.updatedAt));
  const pinned = notes.filter(n=> n.pinned);
  const others = notes.filter(n=> !n.pinned);
  const highlight = (s)=>{ if(!text) return htmlesc(s); return htmlesc(s).replace(new RegExp(text.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&'),'ig'), m=>`<mark style='background:#274768;color:inherit;'>${m}</mark>`); };
  content.innerHTML = `
    <div class='card'>
      <div class='row' style='justify-content:space-between;flex-wrap:wrap;gap:8px;'>
        <strong>üîç Vault</strong>
        <div class='muted' style='font-size:12px;'>${notes.length} result${notes.length!==1?'s':''}${query? ' for "'+htmlesc(query)+'"':''}</div>
      </div>
      <div class='row' style='margin-top:8px;gap:8px;flex-wrap:wrap;'>
        <button id='newNote' class='btn acc' style='font-size:12px;'>New Note</button>
        <button id='sortRecent' class='btn' style='font-size:12px;'>Recent</button>
        <button id='sortAZ' class='btn' style='font-size:12px;'>A-Z</button>
      </div>
      ${tagFilters.length? `<div style='margin-top:8px;'>${tagFilters.map(t=>`<span class='pill'>#${htmlesc(t)}</span>`).join('')}</div>`:''}
    </div>
    ${pinned.length? `<div class='card'><strong style='font-size:14px;'>üìå Pinned</strong><div class='list' style='margin-top:8px;'>${pinned.map(n=> noteRow(n,true)).join('')}</div></div>`:''}
    <div class='card'>
      <strong style='font-size:14px;'>${pinned.length? 'Other Notes':'Notes'}</strong>
      <div class='list' style='margin-top:8px;'>${others.map(n=> noteRow(n,false)).join('') || '<div class="muted">No notes</div>'}</div>
    </div>`;
  function noteRow(n,isPinned){
    const preview = (n.content||'').slice(0,140).replace(/\n/g,' ');
    return `<div class='card' style='padding:10px;'>
      <div class='row' style='justify-content:space-between;'>
        <span style='cursor:pointer;' data-open='${n.id}'>${highlight(n.title)}${n.type==='daily'?` <span class='pill'>${n.dateIndex||''}</span>`:''}${n.type==='idea'?` <span class='pill'>idea</span>`:''}</span>
        <div class='row' style='gap:6px;'>
          <button class='btn' data-pin='${n.id}' style='font-size:11px;'>${isPinned?'Unpin':'Pin'}</button>
          <button class='btn' data-open='${n.id}' style='font-size:11px;'>Open</button>
          <button class='btn' data-del='${n.id}' style='font-size:11px;'>‚úï</button>
        </div>
      </div>
      ${preview?`<div class='muted' style='margin-top:4px;font-size:11px;'>${highlight(preview)}</div>`:''}
      ${(n.tags&&n.tags.length)?`<div style='margin-top:4px;'>${n.tags.map(t=>`<span class='pill' data-tag='${t}'>#${htmlesc(t)}</span>`).join(' ')}</div>`:''}
    </div>`;
  }
  content.querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openNote(b.dataset.open));
  content.querySelectorAll('[data-pin]').forEach(b=> b.onclick=()=>{ const note=db.notes.find(x=>x.id===b.dataset.pin); if(note){ note.pinned=!note.pinned; save(); renderVault(); } });
  content.querySelectorAll('[data-tag]').forEach(b=> b.onclick=()=>{ document.getElementById('q').value='#'+b.dataset.tag; renderVault(); });
  content.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ const note=db.notes.find(x=>x.id===b.dataset.del); if(!note) return; if(!confirm(`Delete note "${note.title}"${note.type==='daily'?' (daily)':''}? This will also remove its tasks.`)) return; db.tasks = db.tasks.filter(t=> t.noteId!==note.id); db.notes = db.notes.filter(n=> n.id!==note.id); save(); renderVault(); });
  document.getElementById('newNote').onclick = ()=> openDraftNote({});
  document.getElementById('sortAZ').onclick = ()=>{ document.getElementById('q').value=''; notes.sort((a,b)=> a.title.localeCompare(b.title)); renderVault(); };
  document.getElementById('sortRecent').onclick = ()=>{ document.getElementById('q').value=''; notes.sort((a,b)=> b.updatedAt.localeCompare(a.updatedAt)); renderVault(); };
}
// --- End added views ---

// --- Links view (restored) ---
function renderLinks(){
  const prevFilter = document.getElementById('linksFilter')?.value || '';
  content.innerHTML = `
    <div class='card'>
      <div class='row' style='justify-content:space-between;flex-wrap:wrap;gap:8px;'>
        <strong>üîó Links</strong>
        <div class='muted' style='font-size:12px;'>Save & manage web resources</div>
      </div>
      <div class='row' style='margin-top:8px;gap:8px;flex-wrap:wrap;'>
        <input id='linkTitle' type='text' placeholder='Title' style='flex:1;min-width:140px;' />
        <input id='linkUrl' type='text' placeholder='https://...' style='flex:1;min-width:180px;' />
        <input id='linkTags' type='text' placeholder='tags (space)' style='flex:1;min-width:120px;' />
        <button id='addLink' class='btn acc'>Add</button>
      </div>
      <div class='row' style='margin-top:8px;gap:8px;flex-wrap:wrap;'>
        <input id='linksFilter' type='text' placeholder='Filter or #tag' style='flex:1;min-width:160px;' value='${htmlesc(prevFilter)}' />
        <button id='exportLinks' class='btn' style='font-size:12px;'>Export</button>
        <button id='clearLinks' class='btn' style='font-size:12px;'>Clear All</button>
      </div>
    </div>
    <div id='linksList' class='list'></div>`;
  const filterEl = document.getElementById('linksFilter');
  function draw(){
    const q = (filterEl.value||'').trim();
    const tagFilters = (q.match(/#[\w-]+/g)||[]).map(t=>t.slice(1).toLowerCase());
    const text = q.replace(/#[\w-]+/g,'').trim().toLowerCase();
    let links = db.links.slice();
    if(tagFilters.length){ links = links.filter(l=> tagFilters.every(t=> (l.tags||[]).map(x=>x.toLowerCase()).includes(t))); }
    if(text){ links = links.filter(l=> l.title.toLowerCase().includes(text) || l.url.toLowerCase().includes(text)); }
    links.sort((a,b)=> (b.pinned?1:0)-(a.pinned?1:0) || b.updatedAt.localeCompare(a.updatedAt));
    const list = document.getElementById('linksList');
    list.innerHTML = links.map(l=> row(l)).join('') || `<div class='card muted'>No links</div>`;
    list.querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> window.open(b.dataset.open,'_blank'));
    list.querySelectorAll('[data-pin]').forEach(b=> b.onclick=()=>{ const l=db.links.find(x=>x.id===b.dataset.pin); if(l){ l.pinned=!l.pinned; save(); draw(); } });
    list.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ if(confirm('Delete link?')){ deleteLink(b.dataset.del); draw(); } });
    list.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> editLink(b.dataset.edit));
    list.querySelectorAll('[data-tag]').forEach(b=> b.onclick=()=>{ const tag=b.dataset.tag; filterEl.value = (filterEl.value.includes('#'+tag)? filterEl.value : (filterEl.value+ ' #'+tag)).trim(); draw(); });
  }
  function row(l){
    return `<div class='card' style='padding:10px;'>
      <div class='row' style='justify-content:space-between;flex-wrap:wrap;gap:6px;'>
        <span style='flex:1;min-width:200px;overflow:hidden;text-overflow:ellipsis;'>${l.pinned?'üìå ':''}<a href='${htmlesc(l.url)}' data-open='${htmlesc(l.url)}' target='_blank' rel='noopener' style='color:var(--acc);text-decoration:none;'>${htmlesc(l.title||l.url)}</a></span>
        <div class='row' style='gap:6px;'>
          <button class='btn' data-edit='${l.id}' style='font-size:11px;'>Edit</button>
          <button class='btn' data-pin='${l.id}' style='font-size:11px;'>${l.pinned?'Unpin':'Pin'}</button>
          <button class='btn' data-del='${l.id}' style='font-size:11px;'>‚úï</button>
        </div>
      </div>
      <div class='muted' style='margin-top:4px;font-size:11px;'>${htmlesc(l.url)}</div>
      ${(l.tags&&l.tags.length)?`<div style='margin-top:4px;'>${l.tags.map(t=>`<span class='pill' data-tag='${t}'>#${htmlesc(t)}</span>`).join(' ')}</div>`:''}
    </div>`;
  }
  function editLink(id){
    const l=db.links.find(x=>x.id===id); if(!l) return;
    const title = prompt('Title', l.title); if(title===null) return;
    const url = prompt('URL', l.url); if(url===null) return;
    const tags = prompt('Tags (space)', (l.tags||[]).join(' ')); if(tags===null) return;
    updateLink(id, {title: title.trim()||url.trim(), url: url.trim(), tags: tags.split(/\s+/).map(t=>t.startsWith('#')?t.slice(1):t).filter(Boolean)}); draw();
  }
  document.getElementById('addLink').onclick = ()=>{
    const title = document.getElementById('linkTitle').value.trim();
    const url = document.getElementById('linkUrl').value.trim();
    if(!url) return;
    const tags = (document.getElementById('linkTags').value||'').split(/\s+/).map(t=>t.startsWith('#')?t.slice(1):t).filter(Boolean);
    createLink({title: title || url, url, tags});
    document.getElementById('linkTitle').value='';
    document.getElementById('linkUrl').value='';
    document.getElementById('linkTags').value='';
    draw();
  };
  filterEl.oninput = draw;
  document.getElementById('exportLinks').onclick = ()=>{
    const blob = new Blob([JSON.stringify(db.links,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='links-export.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('clearLinks').onclick = ()=>{ if(confirm('Delete ALL links?')){ db.links=[]; save(); draw(); } };
  draw();
}
// --- End Links view ---

// --- Note editor ---
function openNote(id){
  const n = db.notes.find(x=>x.id===id); if(!n){ alert('Note not found'); return; }
  content.innerHTML = `
    <div class="card">
      <input id="title" type="text" value="${htmlesc(n.title)}" />
      <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px;">
        <input id="tags" type="text" placeholder="Tags (space separated)" value="${(n.tags||[]).map(t=>'#'+t).join(' ')}" />
        <label style="margin-left:8px;"><input id="pinned" type="checkbox" ${n.pinned?'checked':''}> Pin</label>
        <button id="addSketch" class="btn" style="font-size:12px;">Add Sketch</button>
      </div>
      <div style="margin-top:8px;"><textarea id="contentBox" style="min-height:300px;">${htmlesc(n.content||'')}</textarea></div>
      <div class="row" style="margin-top:8px; gap:8px;flex-wrap:wrap;">
        <button id="save" class="btn acc">Save</button>
        <button id="back" class="btn">Back</button>
        <button id="duplicate" class="btn">Duplicate</button>
        <button id="export" class="btn">Export</button>
        <button id="delete" class="btn" style="border-color:#ff6b6b;color:#ff6b6b;">Delete</button>
      </div>`;
  const saveBtn = document.getElementById('save');
  saveBtn.onclick = ()=>{
    const tagText = document.getElementById('tags').value;
    const tags = tagText ? tagText.split(/\s+/).map(t=>t.startsWith('#')?t.slice(1):t).filter(Boolean) : [];
    updateNote(n.id, {
      title: document.getElementById('title').value,
      content: document.getElementById('contentBox').value,
      tags,
      pinned: document.getElementById('pinned').checked
    });
  };
  document.getElementById('back').onclick = ()=>{
    if(n.type==='daily'){ route='today'; render(); }
    else if(n.projectId){ route='projects'; render(); }
    else if(n.type==='idea'){ route='ideas'; render(); }
    else { route='vault'; render(); }
  };
  document.getElementById('duplicate').onclick = ()=>{
    const copy = createNote({
      title: document.getElementById('title').value + ' (Copy)',
      content: document.getElementById('contentBox').value,
      tags: (document.getElementById('tags').value||'').split(/\s+/).map(t=>t.startsWith('#')?t.slice(1):t).filter(Boolean),
      projectId: n.projectId,
      type: n.type
    });
    openNote(copy.id);
  };
  document.getElementById('export').onclick = ()=>{
    const blob = new Blob([document.getElementById('contentBox').value], {type:'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${n.title.replace(/[^a-z0-9]/gi,'_')}.txt`; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('delete').onclick = ()=>{
    if(!confirm('Delete this note and its tasks? This cannot be undone.')) return;
    // Remove tasks linked to this note
    db.tasks = db.tasks.filter(t=> t.noteId !== n.id);
    // Remove the note
    db.notes = db.notes.filter(x=> x.id !== n.id);
    save();
    if(n.type==='daily'){ route='today'; render(); }
    else if(n.projectId){ route='projects'; render(); }
    else if(n.type==='idea'){ route='ideas'; render(); }
    else { route='vault'; render(); }
  };
  const addSketchBtn = document.getElementById('addSketch');
  if(typeof openSketchModal === 'function') addSketchBtn.onclick = ()=> openSketchModal(n.id);
}

// --- Global app logic ---
function render(){
  renderNav();
  if(route==='today') renderToday();
  else if(route==='projects') renderProjects();
  else if(route==='ideas') renderIdeas();
  else if(route==='links') renderLinks(); // NEW
  else if(route==='vault') renderVault();
  else if(route==='review') renderReview();
  // Update mobile bar active states
  const mb = document.getElementById('mobileBar');
  if(mb){
    mb.querySelectorAll('button[data-nav]').forEach(b=>{
      if(b.dataset.nav===route) b.classList.add('active'); else b.classList.remove('active');
    });
  }
  // Show selected daily date (or today) in sidebar
  const todayDisplayEl = document.getElementById('todayStr');
  if(todayDisplayEl){
    const sel = selectedDailyDate || todayKey();
    if(sel===todayKey()) todayDisplayEl.textContent = new Date().toDateString();
    else todayDisplayEl.textContent = new Date(sel+'T00:00:00').toDateString();
  }
  document.getElementById("dailyRollover").checked = !!db.settings.rollover;
  document.getElementById("dailyRollover").onchange = ()=>{ db.settings.rollover = document.getElementById("dailyRollover").checked; save(db); };
  const autoCarryEl = document.getElementById("autoCarryTasks");
  if(autoCarryEl){
    autoCarryEl.checked = !!db.settings.autoCarryTasks;
    autoCarryEl.onchange = ()=>{ db.settings.autoCarryTasks = autoCarryEl.checked; save(db); };
  }
  const dateInput = document.getElementById('dailyDateNav');
  if(dateInput){
    dateInput.value = selectedDailyDate;
    const prevBtn = document.getElementById('prevDay');
    const nextBtn = document.getElementById('nextDay');
    const today = todayKey();
    prevBtn.onclick = ()=>{ const d=new Date(selectedDailyDate); d.setDate(d.getDate()-1); selectedDailyDate = d.toISOString().slice(0,10); route='today'; render(); };
    nextBtn.onclick = ()=>{ if(selectedDailyDate===today) return; const d=new Date(selectedDailyDate); d.setDate(d.getDate()+1); const newKey=d.toISOString().slice(0,10); if(newKey>today) return; selectedDailyDate=newKey; route='today'; render(); };
    dateInput.onchange = ()=>{ const v=dateInput.value; if(v){ const today=todayKey(); selectedDailyDate = v>today? today : v; route='today'; render(); } };
    nextBtn.disabled = (selectedDailyDate===today);
    nextBtn.style.opacity = nextBtn.disabled? .4 : 1;
  }
  const scratchEl = document.getElementById("scratch");
  if(scratchEl){
    scratchEl.value = db.settings.scratchpad || "";
    scratchEl.oninput = ()=>{ db.settings.scratchpad = scratchEl.value; save(db); };
  }
  if(!db.settings.seenTip){ const t = document.getElementById("tip"); t.style.display="block"; document.getElementById("closeTip").onclick = ()=>{ db.settings.seenTip=true; save(db); t.style.display="none"; }; }
}
document.getElementById("addProject").onclick = ()=> { const name = document.getElementById("newProjectName").value.trim(); if(!name) return; const p = createProject(name); document.getElementById("newProjectName").value=""; currentProjectId = p.id; route='projects'; render(); drawProjectsSidebar(); };
document.getElementById("newDaily").onclick = createOrOpenDaily;
document.getElementById("newNoteBtn").onclick = ()=> {
  const t = prompt("New note title"); if(!t) return;
  const n = createNote({title:t}); openNote(n.id);
};

// Template management
document.getElementById("manageTemplates").onclick = ()=> {
  content.innerHTML = `
    <div class="card">
      <strong>üìù Manage Templates</strong>
      <div class="row" style="margin-top:8px;">
        <input id="templateName" type="text" placeholder="Template name"/>
        <button id="addTemplate" class="btn acc">Add Template</button>
      </div>
      <div style="margin-top:8px;">
        <textarea id="templateContent" placeholder="Template content..."></textarea>
      </div>
    </div>
    <div class="list" id="templateList">
      ${db.templates.map(t=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>${htmlesc(t.name)}</strong>
            <button class="btn" data-del="${t.id}">Delete</button>
          </div>
          <div class="muted" style="margin-top:4px;">${htmlesc(t.content.slice(0,100))}...</div>
        </div>
      `).join("")}
    </div>
    <div style="margin-top:16px;">
      <button class="btn" onclick="render()">‚Üê Back</button>
    </div>`;
    
  document.getElementById("addTemplate").onclick = ()=>{
    const name = document.getElementById("templateName").value.trim();
    const content = document.getElementById("templateContent").value.trim();
    if(!name || !content) return;
    createTemplate(name, content);
    document.getElementById("templateName").value = "";
    document.getElementById("templateContent").value = "";
    document.getElementById("manageTemplates").click(); // Refresh
  };
  
  document.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
    if(confirm("Delete this template?")){
      db.templates = db.templates.filter(t=>t.id!==b.dataset.del);
      save(db);
      document.getElementById("manageTemplates").click(); // Refresh
    }
  });
};

// Search
document.getElementById("q").addEventListener("input", ()=> { if(route!=="vault"){ route="vault"; render(); } else renderVault(); });

// Quick add
document.addEventListener("keydown", (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
    e.preventDefault();
    const t = prompt("Quick add note title");
    if(t){ const n = createNote({title:t}); openNote(n.id); }
  }
  // Quick task shortcut
  if((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase()==="k"){
    e.preventDefault();
    const t = prompt("Quick task (goes to today)");
    if(t){
      const key = todayKey();
      let daily = db.notes.find(n=>n.type==="daily" && n.dateIndex===key);
      if(!daily){
        daily = createNote({title: `${key} ‚Äî Daily`, type:"daily", dateIndex:key, content: db.settings.dailyTemplate || "# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n"});
      }
      const priority = t.startsWith('!') ? 'high' : 'medium';
      const title = t.startsWith('!') ? t.slice(1) : t;
      createTask({title, noteId: daily.id, priority});
      if(route !== "today"){ route = "today"; render(); }
    }
  }
});

// Export
document.addEventListener('DOMContentLoaded', ()=>{
  const exportBtn = document.getElementById('exportBtn');
  if(exportBtn){
    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ultranote-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
    };
  }
  const importFile = document.getElementById('importFile');
  if(importFile){
    importFile.addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data.notes || !data.tasks) throw new Error('Invalid backup file');
          db = data; await persistDB(); location.reload();
        }catch(err){ alert('Import failed: '+err.message); }
      }; reader.readAsText(file);
    });
  }
  // Mobile nav & drawer bindings
  const mobileBar = document.getElementById('mobileBar');
  if(mobileBar && !mobileBar.dataset.bound){
    mobileBar.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-nav]');
      if(!btn) return;
      route = btn.dataset.nav;
      if(route==='today') selectedDailyDate = todayKey();
      render();
    });
    mobileBar.dataset.bound='1';
  }
  const menuBtn = document.getElementById('menuToggle');
  if(menuBtn && !menuBtn.dataset.bound){
    menuBtn.onclick = ()=>{ document.body.classList.toggle('drawer-open'); };
    menuBtn.dataset.bound='1';
  }
  // Close drawer when navigating (desktop or mobile)
  document.addEventListener('click', e=>{
    if(document.body.classList.contains('drawer-open')){
      if(e.target.matches('main, main *')){ document.body.classList.remove('drawer-open'); }
    }
  });
  initApp();
});
</script>
</body>
</html>
