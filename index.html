<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UltraNote Lite (Full, No‚ÄëSW)</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8eef7; --muted:#a9b6c6; --card:#121924; --acc:#4ea1ff; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:#0e141d;position:sticky;top:0;z-index:10;border-bottom:1px solid #1e2a3a}
    .title{font-weight:700;letter-spacing:.3px}
    .search{flex:1;max-width:520px}
    input[type="text"], textarea{width:100%;background:#0f1621;border:1px solid #203041;color:var(--fg);padding:10px;border-radius:10px;outline:none}
    textarea{min-height:140px;resize:vertical}
    main{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px}
    aside{background:var(--card);border:1px solid #1e2938;border-radius:16px;padding:12px;height:calc(100dvh - 88px);position:sticky;top:88px;overflow:auto}
    nav button{width:100%;text-align:left;background:#101827;border:1px solid #213145;color:var(--fg);padding:10px 12px;margin:6px 0;border-radius:10px;cursor:pointer}
    nav button.active{border-color:var(--acc);outline:2px solid color-mix(in oklab, var(--acc) 40%, transparent)}
    .card{background:var(--card);border:1px solid #1e2938;border-radius:16px;padding:14px;margin-bottom:16px}
    .row{display:flex;gap:10px;align-items:center}
    .btn{background:#122134;border:1px solid #274768;color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.acc{border-color:var(--acc)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #334759;border-radius:999px;font-size:12px;color:var(--muted);margin-right:6px}
    .list{display:grid;gap:8px}
    .muted{color:var(--muted);font-size:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    footer{padding:16px;color:var(--muted);text-align:center}
    a{color:var(--acc)}
    .tip{position:fixed;inset:auto 16px 16px 16px;background:#0e141d;border:1px solid #243246;border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .tip h4{margin:0 0 6px 0}
    .kbd{border:1px solid #3a4a60;border-radius:6px;padding:0 6px;margin:0 3px}
    .hidden{display:none}
    /* Project sidebar buttons */
    .projBtn{width:100%;text-align:left;background:#101827;border:1px solid #213145;color:var(--fg);padding:8px 10px;margin:4px 0;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .projBtn.active{border-color:var(--acc);outline:2px solid color-mix(in oklab, var(--acc) 40%, transparent)}
    .projBtn .projDel{font-size:12px;opacity:.55;padding:2px 6px;border-radius:6px;cursor:pointer;}
    .projBtn .projDel:hover{opacity:1;background:#182330;color:#ff6b6b}
  </style>
</head>
<body>
  <header>
    <div class="title">UltraNote Lite</div>
    <div class="search"><input id="q" type="text" placeholder="Search notes, tasks, tags‚Ä¶ (‚åò/Ctrl+K quick add)" /></div>
    <div class="row">
      <button id="newNoteBtn" class="btn">New Note</button>
      <label class="btn" for="importFile">Import</label>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="exportBtn" class="btn acc">Export</button>
      <label class="muted" style="margin-left:8px;"><input id="dailyRollover" type="checkbox"> Rollover incomplete tasks daily</label>
      <label class="muted" style="margin-left:8px;"><input id="autoCarryTasks" type="checkbox"> Auto-carry project tasks</label>
    </div>
  </header>

  <main>
    <aside>
      <nav id="nav"></nav>
      <div class="card">
        <div class="muted">Today: <span id="todayStr"></span></div>
        <button id="newDaily" class="btn" style="margin-top:8px;width:100%;">Open/Create Daily</button>
      </div>
      <div class="card">
        <div class="muted">Projects</div>
        <div id="projectList" class="list"></div>
        <div class="row" style="margin-top:8px;">
          <input id="newProjectName" type="text" placeholder="New project name"/>
          <button id="addProject" class="btn">Add</button>
        </div>
        <div style="margin-top:8px;">
          <button id="manageTemplates" class="btn" style="width:100%;font-size:12px;">Manage Templates</button>
        </div>
      </div>
    </aside>

    <section id="content"></section>
  </main>

  <div id="tip" class="tip" style="display:none;">
    <h4>üöÄ Welcome! Productivity Features</h4>
    <div class="muted">
      ‚Ä¢ <b>üìÖ Today:</b> Daily journal with task priorities (high=red, medium=blue, low=gray)<br>
      ‚Ä¢ <b>üìÅ Projects:</b> Manage project tasks & notes with templates. Pin important notes.<br>
      ‚Ä¢ <b>üí° Ideas:</b> Quick capture with <b>#tags</b>. Type <b>!</b> for high-priority tasks.<br>
      ‚Ä¢ <b>üîç Vault:</b> Search notes, filter by tags (#tag), sort & pin favorites.<br>
      ‚Ä¢ <b>üìä Review:</b> Analytics, project progress, tag cloud, weekly stats.<br>
      <br><b>Shortcuts:</b> <span class="kbd">‚åò/Ctrl</span>+<span class="kbd">K</span> = note, <span class="kbd">‚åò/Ctrl</span>+<span class="kbd">Shift</span>+<span class="kbd">K</span> = task
    </div>
    <div class="row" style="margin-top:10px;justify-content:flex-end;">
      <button id="closeTip" class="btn acc">Got it</button>
    </div>
  </div>

  <footer>Private, local-first. Data stored in your browser. <a href="#" id="resetApp">Reset</a></footer>

<script>
// --- Local-first store (now via backend) ---
const storeKey = "ultranote-lite"; // kept for compatibility
const nowISO = () => new Date().toISOString();
const todayKey = () => new Date().toISOString().slice(0,10);

// Backend persistence helpers
async function fetchDB(){
  try{
    const r = await fetch('/api/db');
    if(!r.ok) throw new Error('Fetch failed');
    const data = await r.json();
    if(!data || !Object.keys(data).length) return null;
    return data;
  }catch(e){ console.warn('Fetch DB error', e); return null; }
}
async function persistDB(){
  try{
    await fetch('/api/db', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(db)});
  }catch(e){ console.error('Persist failed', e); }
  // Always keep a browser backup too (legacy compatibility / offline resilience)
  try { localStorage.setItem(storeKey, JSON.stringify(db)); } catch(err) { /* ignore */ }
}

const seed = {
  version:1,
  settings:{rollover:true, seenTip:false, autoCarryTasks:true, dailyTemplate:"# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n"},
  projects:[{id:"p1", name:"Sample Project", createdAt:nowISO()}],
  notes:[
    {id:"n1", title:"2025-01-01 ‚Äî Daily", content:"# Top 3\n- [ ] Example task A\n- [ ] Example task B\n\n## Journal\nTried UltraNote Lite.\n", tags:[], projectId:null, dateIndex:"2025-01-01", type:"daily", createdAt:nowISO(), updatedAt:nowISO(), pinned:false},
    {id:"n2", title:"Project Plan ‚Äì Sample Project", content:"## Goals\n- Define MVP\n- Ship static site\n\n## Next\n- [ ] Sketch UI\n- [ ] Create first note\n", tags:["plan"], projectId:"p1", dateIndex:null, type:"note", createdAt:nowISO(), updatedAt:nowISO(), pinned:false},
    {id:"n3", title:"Idea: Tablet stylus block", content:"- Add sketch canvas block\n- Save as SVG\n- Optional OCR later", tags:["idea"], projectId:null, dateIndex:null, type:"idea", createdAt:nowISO(), updatedAt:nowISO(), pinned:false}
  ],
  tasks:[{id:"t1", title:"Try adding a task on Today page", status:"TODO", due:null, noteId:"n1", projectId:null, createdAt:nowISO(), completedAt:null}],
  templates:[
    {id:"tpl1", name:"Meeting Notes", content:"# Meeting: [Title]\n**Date:** [Date]\n**Attendees:** \n\n## Agenda\n- \n\n## Notes\n\n## Action Items\n- [ ] \n\n## Next Steps\n"},
    {id:"tpl2", name:"Project Plan", content:"# [Project Name]\n\n## Objective\n\n## Goals\n- \n\n## Milestones\n- [ ] \n\n## Resources\n\n## Risks\n\n## Success Metrics\n"},
    {id:"tpl3", name:"Weekly Review", content:"# Week of [Date]\n\n## Wins\n- \n\n## Challenges\n- \n\n## Lessons Learned\n- \n\n## Next Week Focus\n- [ ] \n"}
  ]
};
const defaults = seed;

// --- Restored runtime glue (was missing) ---
let db; // global in‚Äëmemory state
function uid(){ return Math.random().toString(36).slice(2,10); }
// Backwards compatibility: some calls still pass db => ignore param
function save(){ persistDB(); }

async function initApp(){
  // 1. Try server
  let serverData = await fetchDB();
  if(serverData && Object.keys(serverData).length){
    db = serverData;
  } else {
    // 2. Fallback to any localStorage copy
    try { db = JSON.parse(localStorage.getItem(storeKey)||'null'); } catch(_) { db = null; }
    if(!db) db = JSON.parse(JSON.stringify(defaults));
    await persistDB();
  }
  // Defensive: ensure collections exist
  ['notes','tasks','projects','templates','settings'].forEach(k=>{ if(!db[k]) db[k] = Array.isArray(defaults[k])?[]:{}; });
  // Draw initial UI
  drawProjectsSidebar();
  render();
}
// --- End restored runtime glue ---

// Patch model functions to call save() without args
function createNote({title, content="", tags=[], projectId=null, dateIndex=null, type="note", pinned=false}){
  const n = { id:uid(), title, content, tags, projectId, dateIndex, type, pinned, createdAt:nowISO(), updatedAt:nowISO() };
  db.notes.push(n); save(); return n;
}
function updateNote(id, patch){ const n=db.notes.find(x=>x.id===id); if(!n) return; Object.assign(n, patch, {updatedAt:nowISO()}); save(); return n; }
function createTask({title, due=null, noteId=null, projectId=null, priority="medium"}){
  const t = { id:uid(), title, status:"TODO", due, noteId, projectId, priority, createdAt:nowISO(), completedAt:null };
  db.tasks.push(t); save(); return t;
}
function setTaskStatus(id, status){ const t=db.tasks.find(x=>x.id===id); if(!t) return; t.status=status; t.completedAt = status==="DONE"? nowISO(): null; save(); }
function createProject(name){ const p={id:uid(), name, createdAt:nowISO()}; db.projects.push(p); save(); return p; }
function createTemplate(name, content){ const t={id:uid(), name, content, createdAt:nowISO()}; db.templates.push(t); save(); return t; }
function addTag(text){ const tags = extractTags(text); if(tags.length) { const uniqueTags = [...new Set([...getAllTags(), ...tags])]; } return tags; }
function getAllTags(){ return [...new Set(db.notes.flatMap(n=>n.tags||[]).filter(Boolean))]; }
function extractTags(text){ return (text.match(/#[\w-]+/g) || []).map(tag => tag.slice(1)); }

// --- UI helpers ---
const $ = sel => document.querySelector(sel);
const content = $("#content");
const nav = $("#nav");
const projectList = $("#projectList");

const sections = [
  {id:"today", label:"üìÖ Today"},
  {id:"projects", label:"üìÅ Projects"},
  {id:"ideas", label:"üí° Ideas"},
  {id:"vault", label:"üîç Vault"},
  {id:"review", label:"üìä Review"},
];
let route = "today";
let currentProjectId = null; // NEW: selected project

function renderNav(){
  nav.innerHTML = sections.map(s => `<button data-route="${s.id}" class="${route===s.id?'active':''}">${s.label}</button>`).join("");
  nav.querySelectorAll("button").forEach(b=> b.onclick = ()=>{ route=b.dataset.route; render(); });
}

function htmlesc(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

// --- Views ---
function renderToday(){
  const key = todayKey();
  let daily = db.notes.find(n=>n.type==="daily" && n.dateIndex===key);
  if(!daily){
    if(db.settings.rollover){
      const y = new Date(); y.setDate(y.getDate()-1);
      const yKey = y.toISOString().slice(0,10);
      const yTasks = db.tasks.filter(t=> t.status!=="DONE" && t.noteId && db.notes.find(n=>n.id===t.noteId && n.dateIndex===yKey && n.type==="daily"));
      yTasks.forEach(t=> { createTask({title:t.title, due:null, noteId:null, priority:t.priority||"medium"}); });
    }
    daily = createNote({title: `${key} ‚Äî Daily`, type:"daily", dateIndex:key, content: db.settings.dailyTemplate || "# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n"});
  }
  
  // Get project tasks
  const projectTasks = db.tasks.filter(t=> t.projectId && !t.noteId).sort((a,b)=> {
    const priorities = {high:3, medium:2, low:1};
    return (priorities[b.priority]||2) - (priorities[a.priority]||2);
  });
  
  content.innerHTML = `
    <div class="card">
      <div class="row"><input id="dailyTitle" type="text" value="${htmlesc(daily.title)}"/></div>
      <div style="margin-top:8px;"><textarea id="dailyContent">${htmlesc(daily.content)}</textarea></div>
      <div class="row" style="margin-top:8px;">
        <button id="saveDaily" class="btn acc">Save</button>
        <select id="templateSelect" style="margin-left:8px;padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
          <option value="">Apply Template...</option>
          ${db.templates.map(t=>`<option value="${t.id}">${htmlesc(t.name)}</option>`).join("")}
        </select>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Today's Tasks</strong>
          <button id="showProjectTasks" class="btn" style="font-size:12px;">${projectTasks.length} project tasks</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="taskTitle" type="text" placeholder="Quick task (Enter to add)"/>
          <select id="taskPriority" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div id="taskList" class="list" style="margin-top:8px;"></div>
        <div id="projectTaskList" class="list" style="margin-top:8px;display:none;"></div>
      </div>
      <div class="card">
        <div class="muted">Quick Capture</div>
        <div class="row" style="margin-top:8px;">
          <input id="quickCapture" type="text" placeholder="‚åò/Ctrl+Shift+K for quick add"/>
          <button id="captureBtn" class="btn">Add</button>
        </div>
        <div class="muted" style="margin-top:12px;">Scratchpad</div>
        <textarea id="scratch" placeholder="Temporary notes..."></textarea>
      </div>
    </div>`;
    
  $("#saveDaily").onclick = ()=> {
    updateNote(daily.id, { title: $("#dailyTitle").value, content: $("#dailyContent").value });
  };
  
  // Template application
  $("#templateSelect").onchange = (e)=> {
    if(!e.target.value) return;
    const template = db.templates.find(t=>t.id===e.target.value);
    if(template && confirm(`Apply "${template.name}" template? This will replace current content.`)){
      $("#dailyContent").value = template.content.replace(/\[Date\]/g, new Date().toLocaleDateString()).replace(/\[Title\]/g, '');
    }
    e.target.value = "";
  };
  
  const taskInput = $("#taskTitle");
  const quickCapture = $("#quickCapture");
  
  taskInput.onkeydown = (e)=>{
    if(e.key==="Enter" && taskInput.value.trim()){
      createTask({title:taskInput.value.trim(), noteId: daily.id, priority: $("#taskPriority").value});
      taskInput.value = "";
      drawTasks();
    }
  };
  
  // Quick capture handler
  const handleQuickCapture = ()=>{
    const text = quickCapture.value.trim();
    if(!text) return;
    if(text.startsWith('!')){
      createTask({title:text.slice(1), noteId:daily.id, priority:"high"});
    } else if(text.includes('#')){
      const tags = extractTags(text);
      createNote({title:text, type:"idea", tags});
    } else {
      createTask({title:text, noteId:daily.id, priority:"medium"});
    }
    quickCapture.value = "";
    drawTasks();
  };
  
  quickCapture.onkeydown = (e)=> { if(e.key==="Enter") handleQuickCapture(); };
  $("#captureBtn").onclick = handleQuickCapture;
  
  // Project tasks toggle
  $("#showProjectTasks").onclick = ()=>{
    const list = $("#projectTaskList");
    const isVisible = list.style.display !== "none";
    list.style.display = isVisible ? "none" : "block";
    drawProjectTasks();
  };
  
  function drawTasks(){
    const list = $("#taskList");
    const tasks = db.tasks.filter(t=> t.noteId===daily.id).sort((a,b)=> {
      if(a.status !== b.status) return a.status==="DONE" ? 1 : -1;
      const priorities = {high:3, medium:2, low:1};
      return (priorities[b.priority]||2) - (priorities[a.priority]||2);
    });
    list.innerHTML = tasks.map(t=> {
      const priorityColors = {high:"#ff6b6b", medium:"#4ea1ff", low:"#64748b"};
      return `
      <div class="row" style="justify-content:space-between;">
        <label class="row" style="gap:8px;">
          <input type="checkbox" ${t.status==="DONE"?"checked":""} data-id="${t.id}"/>
          <span class="${t.status==='DONE'?'muted':''}" style="border-left:3px solid ${priorityColors[t.priority||'medium']};padding-left:8px;">${htmlesc(t.title)}</span>
        </label>
        <button class="btn" data-del="${t.id}">Delete</button>
      </div>`;
    }).join("");
    list.querySelectorAll("input[type=checkbox]").forEach(cb=> cb.onchange = ()=> setTaskStatus(cb.dataset.id, cb.checked?"DONE":"TODO"));
    list.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=> { db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(db); drawTasks(); drawProjectTasks(); });
  }
  
  function drawProjectTasks(){
    const list = $("#projectTaskList");
    const tasks = projectTasks.slice(0,10); // Show top 10
    list.innerHTML = tasks.map(t=> {
      const proj = db.projects.find(p=>p.id===t.projectId);
      const priorityColors = {high:"#ff6b6b", medium:"#4ea1ff", low:"#64748b"};
      return `
      <div class="row" style="justify-content:space-between;">
        <label class="row" style="gap:8px;">
          <input type="checkbox" ${t.status==="DONE"?"checked":""} data-id="${t.id}"/>
          <span class="${t.status==='DONE'?'muted':''}" style="border-left:3px solid ${priorityColors[t.priority||'medium']};padding-left:8px;">${htmlesc(t.title)} <span class="pill">${proj?htmlesc(proj.name):'Unknown'}</span></span>
        </label>
        <button class="btn" data-del="${t.id}">Delete</button>
      </div>`;
    }).join("");
    list.querySelectorAll("input[type=checkbox]").forEach(cb=> cb.onchange = ()=> { setTaskStatus(cb.dataset.id, cb.checked?"DONE":"TODO"); drawProjectTasks(); });
    list.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=> { db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(db); drawProjectTasks(); });
  }
  
  drawTasks();
}

function renderProjects(){
  const selectedProject = db.projects.find(p=>p.id===currentProjectId) || null;
  if(!selectedProject){
    content.innerHTML = `
      <div class="card">
        <strong>Select a project</strong>
        <div class="muted" style="margin-top:6px;">Pick a project in the left sidebar (or create one) to add and manage its notes.</div>
      </div>`;
    return;
  }
  let sortBy = "date";
  content.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <strong>Project: ${htmlesc(selectedProject.name)}</strong>
        <div class="row" style="gap:12px;">
          <span class="muted" id="projNoteCount"></span>
          <span class="muted" id="projTaskProgress"></span>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="noteTitle" type="text" placeholder="New note title for this project" />
        <select id="noteTemplate" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
          <option value="">Template...</option>
          ${db.templates.map(t=>`<option value="${t.id}">${htmlesc(t.name)}</option>`).join("")}
        </select>
        <button id="addNote" class="btn acc">Add Note</button>
      </div>
    </div>
    <div class="grid-2">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Project Tasks</strong>
          <span class="muted" id="projProgressInline"></span>
        </div>
        <div class="row" style="margin-top:8px;">
          <input id="taskTitle" type="text" placeholder="New project task"/>
          <select id="taskPriority" style="padding:8px;background:#122134;border:1px solid #274768;color:var(--fg);border-radius:6px;">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
          <button id="addTask" class="btn">Add Task</button>
        </div>
        <div id="taskList" class="list" style="margin-top:8px;"></div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>Notes</strong>
          <div class="row">
            <button id="sortTitle" class="btn" style="font-size:12px;">A-Z</button>
            <button id="sortDate" class="btn" style="font-size:12px;">Date</button>
          </div>
        </div>
        <div id="notes" class="list" style="margin-top:8px;"></div>
      </div>
    </div>`;

  function getProjectTasks(){ return db.tasks.filter(t=>t.projectId===currentProjectId); }
  function getProjectNotes(){ return db.notes.filter(n=>(!n.type || n.type==="note") && n.projectId===currentProjectId); }
  function refreshStats(){
    const tasks = getProjectTasks();
    const notes = getProjectNotes();
    const completed = tasks.filter(t=>t.status==="DONE").length;
    const progress = tasks.length ? Math.round(completed/tasks.length*100) : 0;
    const noteCountEl = document.getElementById("projNoteCount");
    if(noteCountEl) noteCountEl.textContent = `${notes.length} notes`;
    const progEl = document.getElementById("projTaskProgress");
    if(progEl) progEl.textContent = `${completed}/${tasks.length} tasks (${progress}%)`;
    const inline = document.getElementById("projProgressInline");
    if(inline) inline.textContent = `${progress}% complete`;
  }

  document.getElementById("addNote").onclick = ()=>{
    const t = document.getElementById("noteTitle").value.trim();
    if(!t){ alert("Type a title first."); return; }
    const templateId = document.getElementById("noteTemplate").value;
    let contentTxt = "";
    if(templateId){
      const template = db.templates.find(tp=>tp.id===templateId);
      if(template) contentTxt = template.content.replace(/\[Title\]/g, t).replace(/\[Date\]/g, new Date().toLocaleDateString()).replace(/\[Project Name\]/g, selectedProject.name);
    }
    const n = createNote({title:t, projectId:currentProjectId, content:contentTxt});
    document.getElementById("noteTitle").value = "";
    drawNotes();
    refreshStats();
    openNote(n.id);
  };

  document.getElementById("addTask").onclick = ()=>{
    const title = document.getElementById("taskTitle").value.trim();
    if(!title) return;
    createTask({title, projectId:currentProjectId, priority:document.getElementById("taskPriority").value});
    document.getElementById("taskTitle").value = "";
    drawTasks();
    refreshStats();
  };
  document.getElementById("taskTitle").onkeydown = e=>{ if(e.key==="Enter") document.getElementById("addTask").click(); };

  document.getElementById("sortTitle").onclick = ()=>{ sortBy="title"; drawNotes(); };
  document.getElementById("sortDate").onclick = ()=>{ sortBy="date"; drawNotes(); };

  function drawTasks(){
    const tasks = getProjectTasks().sort((a,b)=>{
      if(a.status !== b.status) return a.status==="DONE"?1:-1;
      const priorities={high:3,medium:2,low:1};
      return (priorities[b.priority]||2)-(priorities[a.priority]||2);
    });
    const list = document.getElementById("taskList");
    list.innerHTML = tasks.map(t=>{
      const colors={high:"#ff6b6b",medium:"#4ea1ff",low:"#64748b"};
      return `<div class="row" style="justify-content:space-between;">
        <label class="row" style="gap:8px;">
          <input type="checkbox" ${t.status==="DONE"?"checked":""} data-id="${t.id}"/>
          <span class="${t.status==='DONE'?'muted':''}" style="border-left:3px solid ${colors[t.priority||'medium']};padding-left:8px;">${htmlesc(t.title)}</span>
        </label>
        <button class="btn" data-del="${t.id}">Delete</button>
      </div>`; }).join("");
    list.querySelectorAll("input[type=checkbox]").forEach(cb=> cb.onchange = ()=>{ setTaskStatus(cb.dataset.id, cb.checked?"DONE":"TODO"); drawTasks(); refreshStats(); });
    list.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ db.tasks = db.tasks.filter(x=>x.id!==b.dataset.del); save(db); drawTasks(); refreshStats(); });
  }

  function drawNotes(){
    const notes = getProjectNotes().sort((a,b)=> sortBy==="title"? a.title.localeCompare(b.title) : b.updatedAt.localeCompare(a.updatedAt));
    const listEl = document.getElementById("notes");
    if(!notes.length){ listEl.innerHTML = `<div class='card muted'>No notes yet. Add one above.</div>`; return; }
    listEl.innerHTML = notes.map(n=> `<div class="card">
      <div class="row" style="justify-content:space-between;">
        <strong>${htmlesc(n.title)}</strong>
        <div class="row" style="gap:8px;">
          ${n.pinned?'<span title="Pinned">üìå</span>':''}
          <div class="muted">${new Date(n.updatedAt).toLocaleDateString()}</div>
        </div>
      </div>
      ${n.tags && n.tags.length ? `<div style='margin-top:4px;'>${n.tags.map(tag=>`<span class='pill'>#${htmlesc(tag)}</span>`).join("")}</div>`:""}
      <div class="row" style="margin-top:8px; gap:8px;">
        <button class="btn" data-open="${n.id}">Open</button>
        <button class="btn" data-pin="${n.id}">${n.pinned?'Unpin':'Pin'}</button>
        <button class="btn" data-del="${n.id}">Delete</button>
      </div>
    </div>`).join("");
    listEl.querySelectorAll('[data-open]').forEach(b=> b.onclick = ()=> openNote(b.dataset.open));
    listEl.querySelectorAll('[data-pin]').forEach(b=> b.onclick = ()=>{ const note=db.notes.find(x=>x.id===b.dataset.pin); if(note){ note.pinned=!note.pinned; save(db); drawNotes(); }});
    listEl.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=>{ if(confirm("Delete this note?")){ db.notes = db.notes.filter(x=>x.id!==b.dataset.del); save(db); drawNotes(); refreshStats(); }});
  }

  drawTasks();
  drawNotes();
  refreshStats();
}

function openNote(id){
  const n = db.notes.find(x=>x.id===id); if(!n) return;
  content.innerHTML = `
    <div class="card">
      <input id="title" type="text" value="${htmlesc(n.title)}" />
      <div class="row" style="margin-top:8px;">
        <input id="tags" type="text" placeholder="Tags (space separated)" value="${(n.tags||[]).map(t=>'#'+t).join(' ')}" />
        <label style="margin-left:8px;"><input id="pinned" type="checkbox" ${n.pinned?'checked':''}> Pin</label>
      </div>
      <div style="margin-top:8px;"><textarea id="contentBox">${htmlesc(n.content||"")}</textarea></div>
      <div class="row" style="margin-top:8px; gap:8px;">
        <button id="save" class="btn acc">Save</button>
        <button id="back" class="btn">Back</button>
        <button id="duplicate" class="btn">Duplicate</button>
        <button id="export" class="btn">Export</button>
      </div>
    </div>`;
  $("#save").onclick = ()=> { 
    const tagText = $("#tags").value;
    const tags = tagText ? tagText.split(/\s+/).map(t=>t.startsWith('#')?t.slice(1):t).filter(Boolean) : [];
    updateNote(n.id, { 
      title: $("#title").value, 
      content: $("#contentBox").value, 
      tags,
      pinned: $("#pinned").checked
    });
  };
  $("#back").onclick = ()=> {
    if(n.type==="daily") { route="today"; render(); }
    else if(n.projectId) { route="projects"; render(); }
    else { route="vault"; render(); }
  };
  $("#duplicate").onclick = ()=> {
    const copy = createNote({
      title: $("#title").value + " (Copy)",
      content: $("#contentBox").value,
      tags: ($("#tags").value||"").split(/\s+/).map(t=>t.startsWith('#')?t.slice(1):t).filter(Boolean),
      projectId: n.projectId,
      type: n.type
    });
    openNote(copy.id);
  };
  $("#export").onclick = ()=> {
    const blob = new Blob([$("#contentBox").value], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${$("#title").value.replace(/[^a-z0-9]/gi, '_')}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  };
}

function renderIdeas(){
  content.innerHTML = `
  <div class="card">
    <div class="row"><input id="idea" type="text" placeholder="Capture an idea‚Ä¶ (Enter to add)"/></div>
  </div>
  <div id="ideaList" class="list"></div>`;
  const idea = $("#idea");
  idea.onkeydown = (e)=> { if(e.key==="Enter" && idea.value.trim()){ createNote({title:idea.value.trim(), content:"", type:"idea"}); idea.value=""; draw(); } };
  function draw(){
    const notes = db.notes.filter(n=> n.type==="idea").sort((a,b)=> b.createdAt.localeCompare(a.createdAt));
    $("#ideaList").innerHTML = notes.map(n=> `
      <div class="card row" style="justify-content:space-between;">
        <span>${htmlesc(n.title)}</span>
        <button class="btn" data-del="${n.id}">Delete</button>
      </div>`).join("");
    document.querySelectorAll("[data-del]").forEach(b=> b.onclick=()=>{ db.notes=db.notes.filter(x=>x.id!==b.dataset.del); save(db); draw(); });
  }
  draw();
}

function renderVault(){
  const q = $("#q").value.toLowerCase();
  const allTags = getAllTags();
  let filtered = db.notes;
  
  if(q){
    if(q.startsWith('#')){
      const tag = q.slice(1);
      filtered = db.notes.filter(n=> (n.tags||[]).some(t=>t.toLowerCase().includes(tag)));
    } else {
      filtered = db.notes.filter(n=> (n.title+(n.content||"")).toLowerCase().includes(q));
    }
  }
  
  const pinned = filtered.filter(n=>n.pinned).sort((a,b)=> b.updatedAt.localeCompare(a.updatedAt));
  const others = filtered.filter(n=>!n.pinned).sort((a,b)=> b.updatedAt.localeCompare(a.updatedAt));
  const all = [...pinned, ...others];
  
  content.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">${all.length} results</div>
        <div class="row">
          <button id="sortDate" class="btn" style="font-size:12px;">Date</button>
          <button id="sortTitle" class="btn" style="font-size:12px;">A-Z</button>
        </div>
      </div>
      ${allTags.length ? `<div style="margin-top:8px;">${allTags.slice(0,15).map(tag=>`<button class="pill" data-tag="${tag}" style="cursor:pointer;">#${htmlesc(tag)}</button>`).join("")}</div>` : ""}
    </div>
    <div class="list" id="noteList">${renderNoteList(all)}</div>`;
    
  document.querySelectorAll("[data-open]").forEach(b=> b.onclick=()=> openNote(b.dataset.open));
  document.querySelectorAll("[data-tag]").forEach(b=> b.onclick=()=> { $("#q").value = '#' + b.dataset.tag; renderVault(); });
  
  let sortBy = "date";
  document.getElementById("sortDate").onclick = ()=>{ sortBy="date"; redraw(); };
  document.getElementById("sortTitle").onclick = ()=>{ sortBy="title"; redraw(); };
  
  function redraw(){
    const sorted = sortBy==="title" ? all.sort((a,b)=>a.title.localeCompare(b.title)) : all.sort((a,b)=> b.updatedAt.localeCompare(a.updatedAt));
    document.getElementById("noteList").innerHTML = renderNoteList(sorted);
    document.querySelectorAll("[data-open]").forEach(b=> b.onclick=()=> openNote(b.dataset.open));
  }
  
  function renderNoteList(notes){
    return notes.map(n=> `
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <strong>${n.pinned ? 'üìå ' : ''}${htmlesc(n.title)}</strong>
          <span class="muted">${new Date(n.updatedAt).toLocaleDateString()}</span>
        </div>
        ${n.tags && n.tags.length ? `<div style="margin-top:4px;">${n.tags.map(tag=>`<span class="pill">#${htmlesc(tag)}</span>`).join("")}</div>` : ""}
        <div class="muted">${htmlesc((n.content||'').slice(0,140))}${n.content && n.content.length > 140 ? '‚Ä¶' : ''}</div>
        <div style="margin-top:8px;"><button class="btn" data-open="${n.id}">Open</button></div>
      </div>`).join("");
  }
}

function renderReview(){
  const done = db.tasks.filter(t=> t.status==="DONE");
  const total = db.tasks.length || 1;
  const pct = Math.round(done.length/total*100);
  
  // Weekly stats
  const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate()-7);
  const weekTasks = db.tasks.filter(t=> t.completedAt && new Date(t.completedAt) > weekAgo);
  const weekNotes = db.notes.filter(n=> new Date(n.createdAt) > weekAgo);
  
  // Project progress
  const projectStats = db.projects.map(p=>{
    const tasks = db.tasks.filter(t=>t.projectId===p.id);
    const completed = tasks.filter(t=>t.status==="DONE").length;
    return {project: p, total: tasks.length, completed, progress: tasks.length ? Math.round(completed/tasks.length*100) : 0};
  }).filter(s=>s.total>0);
  
  content.innerHTML = `
    <div class="grid-2">
      <div class="card">
        <strong>üìä Analytics</strong>
        <div class="muted" style="margin-top:6px;">Tasks completed: ${done.length}/${total} (${pct}%)</div>
        <div class="muted">This week: ${weekTasks.length} tasks, ${weekNotes.length} notes</div>
      </div>
      
      <div class="card">
        <strong>üéØ Project Progress</strong>
        <div class="list" style="margin-top:8px;">
          ${projectStats.map(s=>`
            <div class="row" style="justify-content:space-between;">
              <span>${htmlesc(s.project.name)}</span>
              <span class="muted">${s.completed}/${s.total} (${s.progress}%)</span>
            </div>
          `).join("") || '<div class="muted">No project tasks yet</div>'}
        </div>
      </div>
    </div>
    
    <div class="card">
      <strong>üìÖ Recent Daily Logs</strong>
      <div class="list" style="margin-top:8px;">${db.notes.filter(n=>n.type==="daily").slice(-7).reverse().map(n=> `
        <div class="row" style="justify-content:space-between;">
          <span>${htmlesc(n.title)}</span>
          <button class="btn" data-open="${n.id}">Open</button>
        </div>`).join("")}</div>
    </div>
    
    <div class="card">
      <strong>üè∑Ô∏è Tag Cloud</strong>
      <div style="margin-top:8px;">
        ${getAllTags().slice(0,20).map(tag=>{
          const count = db.notes.filter(n=>(n.tags||[]).includes(tag)).length;
          return `<button class="pill" data-tag="${tag}" style="cursor:pointer;margin:2px;">#${htmlesc(tag)} (${count})</button>`;
        }).join("") || '<div class="muted">No tags yet</div>'}
      </div>
    </div>`;
    
  document.querySelectorAll("[data-open]").forEach(b=> b.onclick=()=> openNote(b.dataset.open));
  document.querySelectorAll("[data-tag]").forEach(b=> b.onclick=()=> { 
    route="vault"; 
    $("#q").value = '#' + b.dataset.tag; 
    render(); 
  });
}

function render(){
  renderNav();
  if(route==="today") renderToday();
  else if(route==="projects") renderProjects();
  else if(route==="ideas") renderIdeas();
  else if(route==="vault") renderVault();
  else if(route==="review") renderReview();
  document.getElementById("todayStr").textContent = new Date().toDateString();
  document.getElementById("dailyRollover").checked = !!db.settings.rollover;
  document.getElementById("dailyRollover").onchange = ()=>{ db.settings.rollover = document.getElementById("dailyRollover").checked; save(db); };
  
  const autoCarryEl = document.getElementById("autoCarryTasks");
  if(autoCarryEl){
    autoCarryEl.checked = !!db.settings.autoCarryTasks;
    autoCarryEl.onchange = ()=>{ db.settings.autoCarryTasks = autoCarryEl.checked; save(db); };
  }
  
  // Auto-save scratch content
  const scratchEl = document.getElementById("scratch");
  if(scratchEl){
    scratchEl.value = db.settings.scratchpad || "";
    scratchEl.oninput = ()=>{ db.settings.scratchpad = scratchEl.value; save(db); };
  }
  
  // Tip
  if(!db.settings.seenTip){ const t = document.getElementById("tip"); t.style.display="block"; document.getElementById("closeTip").onclick = ()=>{ db.settings.seenTip=true; save(db); t.style.display="none"; }; }
}

// Sidebar projects
function drawProjectsSidebar(){
  // Render project buttons
  projectList.innerHTML = db.projects.map(p=> `
    <button class="projBtn ${currentProjectId===p.id?"active":""}" data-proj="${p.id}" title="Select project">
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${htmlesc(p.name)}</span>
      <span class="projDel" data-del="${p.id}" title="Delete project">‚úï</span>
    </button>`).join("");
  // Attach a single event listener once (delegation)
  if(!projectList.dataset.bound){
    projectList.addEventListener('click', (e)=>{
      const delEl = e.target.closest('.projDel');
      if(delEl){
        e.stopPropagation();
        const pid = delEl.dataset.del;
        const proj = db.projects.find(p=>p.id===pid);
        if(!proj) return;
        // Provide a clearer confirm message with counts
        const noteCount = db.notes.filter(n=>n.projectId===pid).length;
        const taskCount = db.tasks.filter(t=>t.projectId===pid).length;
        const msg = `Delete project "${proj.name}"${noteCount||taskCount?` (and its ${noteCount} notes / ${taskCount} tasks)`:""}? This cannot be undone.`;
        if(!confirm(msg)) return;
        db.notes = db.notes.filter(n=> n.projectId!==pid);
        db.tasks = db.tasks.filter(t=> t.projectId!==pid);
        db.projects = db.projects.filter(p=> p.id!==pid);
        if(currentProjectId===pid) currentProjectId = null;
        save(db);
        drawProjectsSidebar();
        if(route==='projects') render();
        return;
      }
      const btn = e.target.closest('.projBtn');
      if(btn){
        const pid = btn.dataset.proj;
        if(currentProjectId!==pid){
          currentProjectId = pid;
          route='projects';
          render();
          drawProjectsSidebar();
        }
      }
    });
    projectList.dataset.bound = '1';
  }
}
document.getElementById("addProject").onclick = ()=> { const name = document.getElementById("newProjectName").value.trim(); if(!name) return; const p = createProject(name); document.getElementById("newProjectName").value=""; currentProjectId = p.id; route='projects'; render(); drawProjectsSidebar(); };
document.getElementById("newDaily").onclick = ()=> { route="today"; render(); };
document.getElementById("newNoteBtn").onclick = ()=> {
  const t = prompt("New note title"); if(!t) return;
  const n = createNote({title:t}); openNote(n.id);
};

// Template management
document.getElementById("manageTemplates").onclick = ()=> {
  content.innerHTML = `
    <div class="card">
      <strong>üìù Manage Templates</strong>
      <div class="row" style="margin-top:8px;">
        <input id="templateName" type="text" placeholder="Template name"/>
        <button id="addTemplate" class="btn acc">Add Template</button>
      </div>
      <div style="margin-top:8px;">
        <textarea id="templateContent" placeholder="Template content..."></textarea>
      </div>
    </div>
    <div class="list" id="templateList">
      ${db.templates.map(t=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <strong>${htmlesc(t.name)}</strong>
            <button class="btn" data-del="${t.id}">Delete</button>
          </div>
          <div class="muted" style="margin-top:4px;">${htmlesc(t.content.slice(0,100))}...</div>
        </div>
      `).join("")}
    </div>
    <div style="margin-top:16px;">
      <button class="btn" onclick="render()">‚Üê Back</button>
    </div>`;
    
  document.getElementById("addTemplate").onclick = ()=>{
    const name = document.getElementById("templateName").value.trim();
    const content = document.getElementById("templateContent").value.trim();
    if(!name || !content) return;
    createTemplate(name, content);
    document.getElementById("templateName").value = "";
    document.getElementById("templateContent").value = "";
    document.getElementById("manageTemplates").click(); // Refresh
  };
  
  document.querySelectorAll("[data-del]").forEach(b=> b.onclick = ()=>{
    if(confirm("Delete this template?")){
      db.templates = db.templates.filter(t=>t.id!==b.dataset.del);
      save(db);
      document.getElementById("manageTemplates").click(); // Refresh
    }
  });
};

// Search
document.getElementById("q").addEventListener("input", ()=> { if(route!=="vault"){ route="vault"; render(); } else renderVault(); });

// Quick add
document.addEventListener("keydown", (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
    e.preventDefault();
    const t = prompt("Quick add note title");
    if(t){ const n = createNote({title:t}); openNote(n.id); }
  }
  // Quick task shortcut
  if((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase()==="k"){
    e.preventDefault();
    const t = prompt("Quick task (goes to today)");
    if(t){
      const key = todayKey();
      let daily = db.notes.find(n=>n.type==="daily" && n.dateIndex===key);
      if(!daily){
        daily = createNote({title: `${key} ‚Äî Daily`, type:"daily", dateIndex:key, content: db.settings.dailyTemplate || "# Top 3\n- [ ] \n- [ ] \n- [ ] \n\n## Tasks\n\n## Journal\n\n## Wins\n"});
      }
      const priority = t.startsWith('!') ? 'high' : 'medium';
      const title = t.startsWith('!') ? t.slice(1) : t;
      createTask({title, noteId: daily.id, priority});
      if(route !== "today"){ route = "today"; render(); }
    }
  }
});

// Export
document.addEventListener('DOMContentLoaded', ()=>{
  const exportBtn = document.getElementById('exportBtn');
  if(exportBtn){
    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ultranote-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href);
    };
  }
  const importFile = document.getElementById('importFile');
  if(importFile){
    importFile.addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data.notes || !data.tasks) throw new Error('Invalid backup file');
          db = data; await persistDB(); location.reload();
        }catch(err){ alert('Import failed: '+err.message); }
      }; reader.readAsText(file);
    });
  }
  initApp();
});
</script>
</body>
</html>
